<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SV Dashboard v3.0 | Portfolio Management & Advanced Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // Suprimir warning de Tailwind
        if (typeof console !== 'undefined') {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0]?.includes('Tailwind CSS')) return;
                originalWarn.apply(console, args);
            };
        }
    </script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .tab-active { border-bottom: 3px solid #6366f1; color: #6366f1; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 font-sans min-h-screen">

    <!-- Header -->
    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-xl border-b border-indigo-500/30">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl">
                    <i class="fa-solid fa-chart-line text-white"></i>
                </div>
                <h1 class="text-xl font-bold">SV <span class="text-indigo-400 font-light">Portfolio Manager v3.0</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <select id="portfolio-selector" onchange="switchPortfolio()" class="bg-slate-800 border border-indigo-500/30 rounded-xl px-4 py-2 text-sm font-bold">
                    <option value="default">Portafolio Principal</option>
                </select>
                <button onclick="openPortfolioManager()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl text-sm font-bold">
                    <i class="fa-solid fa-folder-plus mr-2"></i>Gestionar
                </button>
                <button onclick="openSettings()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-xl text-sm font-bold">
                    <i class="fa-solid fa-sliders mr-2"></i>Configuraci√≥n
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 max-w-[1800px]">
        
        <!-- Tabs Navigation -->
        <div class="flex gap-2 mb-6 bg-white rounded-2xl p-2 shadow-sm overflow-x-auto custom-scroll">
            <button onclick="switchTab('overview')" id="tab-overview" class="tab-active px-6 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all">
                <i class="fa-solid fa-gauge mr-2"></i>Vista General
            </button>
            <button onclick="switchTab('analytics')" id="tab-analytics" class="px-6 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all hover:bg-slate-50">
                <i class="fa-solid fa-chart-pie mr-2"></i>An√°lisis
            </button>
            <button onclick="switchTab('projections')" id="tab-projections" class="px-6 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all hover:bg-slate-50">
                <i class="fa-solid fa-chart-line mr-2"></i>Proyecciones
            </button>
            <button onclick="switchTab('risk')" id="tab-risk" class="px-6 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all hover:bg-slate-50">
                <i class="fa-solid fa-shield-halved mr-2"></i>Riesgo
            </button>
            <button onclick="switchTab('comparison')" id="tab-comparison" class="px-6 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all hover:bg-slate-50">
                <i class="fa-solid fa-code-compare mr-2"></i>Comparaci√≥n
            </button>
        </div>

        <!-- TAB: Vista General -->
        <div id="content-overview" class="tab-content">
            
            <!-- KPIs Row -->
            <div class="grid grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
                <div class="glass-card p-4 rounded-2xl shadow-sm border-b-4 border-indigo-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black tracking-widest mb-1">Valor Total</p>
                    <h3 id="kpi-total" class="text-xl font-black text-slate-800">$0.00</h3>
                    <p id="kpi-total-change" class="text-[10px] font-bold mt-1 text-slate-400">+0.00%</p>
                </div>
                <div class="glass-card p-4 rounded-2xl shadow-sm border-b-4 border-emerald-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black tracking-widest mb-1">Meta Semanal</p>
                    <h3 id="kpi-weekly" class="text-xl font-black text-emerald-600">+$0.00</h3>
                    <p class="text-[10px] text-slate-400 mt-1 font-bold" id="kpi-weekly-pct">0.35%</p>
                </div>
                <div class="glass-card p-4 rounded-2xl shadow-sm border-b-4 border-amber-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black tracking-widest mb-1">Beta</p>
                    <h3 id="kpi-beta" class="text-xl font-black text-slate-800">0.00</h3>
                    <p id="kpi-beta-label" class="text-[10px] text-slate-400 mt-1 font-bold">--</p>
                </div>
                <div class="glass-card p-4 rounded-2xl shadow-sm border-b-4 border-purple-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black tracking-widest mb-1">Sharpe Ratio</p>
                    <h3 id="kpi-sharpe" class="text-xl font-black text-slate-800">0.00</h3>
                    <p id="kpi-sharpe-label" class="text-[10px] text-slate-400 mt-1 font-bold">Riesgo/Ret.</p>
                </div>
                <div class="glass-card p-4 rounded-2xl shadow-sm border-b-4 border-rose-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black tracking-widest mb-1">Max Drawdown</p>
                    <h3 id="kpi-drawdown" class="text-xl font-black text-slate-800">0.00%</h3>
                    <p class="text-[10px] text-slate-400 mt-1 font-bold">P√©rdida M√°x</p>
                </div>
                <div class="glass-card p-4 rounded-2xl shadow-sm border-b-4 border-cyan-500">
                    <p class="text-[9px] text-slate-500 uppercase font-black tracking-widest mb-1">Diversificaci√≥n</p>
                    <h3 id="kpi-diversification" class="text-xl font-black text-slate-800">0</h3>
                    <p id="kpi-div-label" class="text-[10px] text-slate-400 mt-1 font-bold">Sectores</p>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Portfolio Holdings -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-card rounded-2xl shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white/50">
                            <h3 class="font-black text-slate-700 uppercase text-xs">Posiciones Actuales</h3>
                            <button onclick="toggleModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold">
                                <i class="fa-solid fa-plus mr-1"></i>Agregar
                            </button>
                        </div>
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50/50 text-slate-400 text-[9px] uppercase font-black border-b border-slate-100">
                                    <tr>
                                        <th class="p-3">Activo</th>
                                        <th class="p-3 text-right">Cantidad</th>
                                        <th class="p-3 text-right">Precio</th>
                                        <th class="p-3 text-right">Valor</th>
                                        <th class="p-3 text-center">Rend. %</th>
                                        <th class="p-3 text-center">Peso %</th>
                                        <th class="p-3 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="portfolio-body" class="divide-y divide-slate-100 text-sm">
                                    <!-- JS injection -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats & Charts -->
                <div class="space-y-6">
                    <!-- Diversification Chart -->
                    <div class="glass-card p-5 rounded-2xl shadow-sm">
                        <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Diversificaci√≥n Sectorial</h3>
                        <div class="relative h-64">
                            <canvas id="diversification-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Performers -->
                    <div class="glass-card p-5 rounded-2xl shadow-sm">
                        <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Top/Bottom Performers</h3>
                        <div id="top-performers" class="space-y-2">
                            <!-- JS injection -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: An√°lisis -->
        <div id="content-analytics" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Sector Analysis -->
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">An√°lisis por Sector</h3>
                    <div class="h-80">
                        <canvas id="sector-bar-chart"></canvas>
                    </div>
                </div>

                <!-- Risk/Return Scatter -->
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Matriz Riesgo/Retorno</h3>
                    <div class="h-80">
                        <canvas id="risk-return-chart"></canvas>
                    </div>
                </div>

                <!-- Correlation Heatmap -->
                <div class="glass-card p-6 rounded-2xl shadow-sm lg:col-span-2">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Matriz de Correlaci√≥n</h3>
                    <div class="h-96">
                        <canvas id="correlation-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Proyecciones -->
        <div id="content-projections" class="tab-content hidden">
            <div class="grid grid-cols-1 gap-6">
                
                <!-- Projection Controls -->
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Par√°metros de Proyecci√≥n</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2">Meta Anual (%)</label>
                            <input type="number" id="annual-target" value="20" step="1" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold" onchange="updateProjections()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2">Horizonte (semanas)</label>
                            <input type="number" id="projection-weeks" value="52" step="1" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold" onchange="updateProjections()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2">Escenario</label>
                            <select id="scenario-type" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold" onchange="updateProjections()">
                                <option value="optimistic">Optimista (+10%)</option>
                                <option value="base" selected>Base</option>
                                <option value="pessimistic">Pesimista (-10%)</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="updateProjections()" class="w-full bg-indigo-600 text-white rounded-xl p-3 text-sm font-bold hover:bg-indigo-700">
                                <i class="fa-solid fa-rotate mr-2"></i>Actualizar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Multi-Scenario Chart -->
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Proyecci√≥n Multi-Escenario</h3>
                    <div class="h-96">
                        <canvas id="projection-chart"></canvas>
                    </div>
                </div>

                <!-- Monthly Breakdown -->
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Desglose Mensual</h3>
                    <div class="h-64">
                        <canvas id="monthly-projection-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Riesgo -->
        <div id="content-risk" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Risk Metrics -->
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">M√©tricas de Riesgo</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl">
                            <p class="text-xs text-slate-600 mb-1">Volatilidad Anualizada</p>
                            <p id="risk-volatility" class="text-2xl font-black text-slate-800">--</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl">
                            <p class="text-xs text-slate-600 mb-1">Sharpe Ratio</p>
                            <p id="risk-sharpe" class="text-2xl font-black text-slate-800">--</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl">
                            <p class="text-xs text-slate-600 mb-1">Sortino Ratio</p>
                            <p id="risk-sortino" class="text-2xl font-black text-slate-800">--</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl">
                            <p class="text-xs text-slate-600 mb-1">VaR (95%)</p>
                            <p id="risk-var" class="text-2xl font-black text-rose-600">--</p>
                        </div>
                    </div>
                </div>

                <!-- Beta Distribution -->
                <div class="glass-card p-6 rounded-2xl shadow-sm lg:col-span-2">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Distribuci√≥n de Beta</h3>
                    <div class="h-80">
                        <canvas id="beta-distribution-chart"></canvas>
                    </div>
                </div>

                <!-- Concentration Risk -->
                <div class="glass-card p-6 rounded-2xl shadow-sm lg:col-span-3">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Riesgo de Concentraci√≥n</h3>
                    <div class="h-64">
                        <canvas id="concentration-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Comparaci√≥n -->
        <div id="content-comparison" class="tab-content hidden">
            <div class="grid grid-cols-1 gap-6">
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Comparar Portafolios</h3>
                    <p class="text-slate-600 text-sm">Selecciona portafolios para comparar m√©tricas y rendimiento</p>
                    <div id="comparison-content" class="mt-4">
                        <!-- Dynamic comparison content -->
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Portfolio Manager -->
    <div id="portfolio-manager-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">Gesti√≥n de Portafolios</h3>
                <button onclick="closePortfolioManager()" class="text-slate-400 hover:text-rose-500 text-2xl">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex gap-3">
                    <input type="text" id="new-portfolio-name" placeholder="Nombre del nuevo portafolio" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold">
                    <button onclick="createPortfolio()" class="bg-emerald-600 text-white px-6 rounded-xl font-bold hover:bg-emerald-700">
                        <i class="fa-solid fa-plus mr-2"></i>Crear
                    </button>
                </div>
                
                <div id="portfolio-list" class="space-y-2 max-h-96 overflow-y-auto custom-scroll">
                    <!-- Portfolio list -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-3xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">Configuraci√≥n Global</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-rose-500 text-2xl">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- API Keys -->
                <div class="space-y-4">
                    <h4 class="font-black text-slate-700 uppercase text-xs">API Keys</h4>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Marketstack</label>
                        <input type="text" id="settings-marketstack" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Alpha Vantage</label>
                        <input type="text" id="settings-alphavantage" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Blackbox AI</label>
                        <input type="text" id="settings-blackbox" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-mono">
                    </div>
                </div>
                
                <!-- General Settings -->
                <div class="space-y-4">
                    <h4 class="font-black text-slate-700 uppercase text-xs">Preferencias</h4>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Tasa Libre de Riesgo (%)</label>
                        <input type="number" id="settings-risk-free-rate" value="4.5" step="0.1" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Intervalo de Actualizaci√≥n (min)</label>
                        <input type="number" id="settings-refresh-interval" value="5" step="1" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Moneda</label>
                        <select id="settings-currency" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold">
                            <option value="USD" selected>USD ($)</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="GBP">GBP (¬£)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex gap-3">
                <button onclick="saveSettings()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">
                    <i class="fa-solid fa-floppy-disk mr-2"></i>Guardar Cambios
                </button>
                <button onclick="resetSettings()" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold hover:bg-slate-300">
                    Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Position (Simple) -->
    <div id="add-position-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md p-8">
            <h3 class="text-2xl font-black text-slate-800 mb-6">Agregar Posici√≥n</h3>
            <form id="add-position-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-2">Ticker</label>
                    <input type="text" id="add-ticker" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold uppercase">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Cantidad</label>
                        <input type="number" id="add-shares" step="0.01" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Costo Prom.</label>
                        <input type="number" id="add-cost" step="0.01" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">
                        Agregar
                    </button>
                    <button type="button" onclick="toggleModal()" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold hover:bg-slate-300">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        const MARKETSTACK_KEY = "23a66d211dff2055ab1d264c7ed122b2";
        const ALPHA_VANTAGE_KEY = "CJIOJ9QSU8A2JM7R";
        const BLACKBOX_KEY = "sk-Vl6HBMkEaEzvj6x_qfrfhA";
        
        let currentPortfolioId = 'default';
        let portfolios = JSON.parse(localStorage.getItem('sv_portfolios_v3')) || {
            'default': { name: 'Portafolio Principal', positions: [] }
        };
        let cachedPrices = JSON.parse(localStorage.getItem('sv_cached_prices')) || {};
        let settings = JSON.parse(localStorage.getItem('sv_settings_v3')) || {
            riskFreeRate: 4.5,
            refreshInterval: 5,
            currency: 'USD',
            annualTarget: 20
        };
        let charts = {};
        
        // ===== STOCK REFERENCE DATA =====
        const stockRef = {
            "AVGO": { beta: 1.15, dgr: 18.5, yield: 1.4, sector: 'Tecnolog√≠a/AI', name: 'Broadcom Inc.' },
            "AAPL": { beta: 1.24, dgr: 7.5, yield: 0.5, sector: 'Tecnolog√≠a', name: 'Apple Inc.' },
            "MSFT": { beta: 0.89, dgr: 10.2, yield: 0.8, sector: 'Tecnolog√≠a', name: 'Microsoft Corp.' },
            "NVDA": { beta: 1.68, dgr: 15.2, yield: 0.03, sector: 'Tecnolog√≠a/AI', name: 'NVIDIA Corp.' },
            "GOOGL": { beta: 1.05, dgr: 0.0, yield: 0.0, sector: 'Tecnolog√≠a', name: 'Alphabet Inc.' },
            "META": { beta: 1.18, dgr: 0.0, yield: 0.0, sector: 'Tecnolog√≠a', name: 'Meta Platforms Inc.' },
            "TSLA": { beta: 2.01, dgr: 0.0, yield: 0.0, sector: 'Tecnolog√≠a/Auto', name: 'Tesla Inc.' },
            "JNJ": { beta: 0.54, dgr: 5.8, yield: 3.0, sector: 'Salud', name: 'Johnson & Johnson' },
            "ABBV": { beta: 0.58, dgr: 12.4, yield: 3.4, sector: 'Salud', name: 'AbbVie Inc.' },
            "PFE": { beta: 0.62, dgr: 5.5, yield: 5.8, sector: 'Salud', name: 'Pfizer Inc.' },
            "UNH": { beta: 0.75, dgr: 12.8, yield: 1.3, sector: 'Salud', name: 'UnitedHealth Group' },
            "MAIN": { beta: 1.05, dgr: 4.2, yield: 6.8, sector: 'Finanzas', name: 'Main Street Capital' },
            "JPM": { beta: 1.12, dgr: 8.5, yield: 2.4, sector: 'Finanzas', name: 'JPMorgan Chase & Co.' },
            "BAC": { beta: 1.25, dgr: 7.2, yield: 2.8, sector: 'Finanzas', name: 'Bank of America' },
            "V": { beta: 0.95, dgr: 17.5, yield: 0.7, sector: 'Finanzas', name: 'Visa Inc.' },
            "MA": { beta: 1.02, dgr: 18.2, yield: 0.5, sector: 'Finanzas', name: 'Mastercard Inc.' },
            "XOM": { beta: 1.02, dgr: 3.8, yield: 3.6, sector: 'Energ√≠a', name: 'Exxon Mobil Corp.' },
            "CVX": { beta: 0.95, dgr: 6.2, yield: 3.4, sector: 'Energ√≠a', name: 'Chevron Corp.' },
            "COP": { beta: 1.15, dgr: 8.5, yield: 2.8, sector: 'Energ√≠a', name: 'ConocoPhillips' },
            "PEP": { beta: 0.52, dgr: 7.2, yield: 2.9, sector: 'Consumo', name: 'PepsiCo Inc.' },
            "KO": { beta: 0.59, dgr: 4.0, yield: 3.1, sector: 'Consumo', name: 'Coca-Cola Company' },
            "WMT": { beta: 0.51, dgr: 9.2, yield: 1.5, sector: 'Retail', name: 'Walmart Inc.' }
        };

        // ===== INITIALIZATION =====
        window.onload = async () => {
            loadPortfolioSelector();
            loadSettings();
            switchTab('overview');
            await preloadStockPrices();
            await updateCurrentPortfolioPrices();
            renderPortfolio();
            updateAllCharts();
            
            // Auto-refresh prices
            setInterval(() => {
                updateCurrentPortfolioPrices();
            }, settings.refreshInterval * 60 * 1000);
        };
        
        // ===== PRICE LOADING =====
        async function preloadStockPrices() {
            const tickers = Object.keys(stockRef);
            const now = Date.now();
            const cacheExpiry = 15 * 60 * 1000;
            
            if (cachedPrices.timestamp && (now - cachedPrices.timestamp) < cacheExpiry) {
                console.log('‚úÖ Usando precios en cach√©');
                return;
            }

            console.log('üöÄ Cargando precios con Marketstack...');
            
            const newCache = { timestamp: now, prices: cachedPrices.prices || {} };
            const batchSize = 50;
            
            for (let i = 0; i < tickers.length; i += batchSize) {
                const batch = tickers.slice(i, i + batchSize);
                const tickerString = batch.join(',');
                
                try {
                    const res = await fetch(
                        `http://api.marketstack.com/v1/eod/latest?access_key=${MARKETSTACK_KEY}&symbols=${tickerString}&limit=1`
                    );
                    const data = await res.json();
                    
                    if (data.data && Array.isArray(data.data)) {
                        data.data.forEach(quote => {
                            newCache.prices[quote.symbol] = parseFloat(quote.close || quote.open);
                        });
                    }
                    
                    cachedPrices = newCache;
                    localStorage.setItem('sv_cached_prices', JSON.stringify(cachedPrices));
                    
                    if (i + batchSize < tickers.length) {
                        await new Promise(r => setTimeout(r, 1000));
                    }
                } catch (e) {
                    console.error('Error cargando precios:', e);
                }
            }
            
            console.log(`‚úÖ ${Object.keys(newCache.prices).length}/${tickers.length} precios cargados`);
        }

        async function updateCurrentPortfolioPrices() {
            const portfolio = getCurrentPortfolio();
            const tickers = portfolio.positions.map(p => p.ticker).join(',');
            
            if (!tickers) return;
            
            try {
                const res = await fetch(
                    `http://api.marketstack.com/v1/eod/latest?access_key=${MARKETSTACK_KEY}&symbols=${tickers}&limit=1`
                );
                const data = await res.json();
                
                if (data.data) {
                    data.data.forEach(quote => {
                        const pos = portfolio.positions.find(p => p.ticker === quote.symbol);
                        if (pos) {
                            pos.currentPrice = parseFloat(quote.close || quote.open);
                        }
                    });
                    
                    savePortfolios();
                    renderPortfolio();
                    updateAllCharts();
                }
            } catch (e) {
                console.error('Error actualizando precios:', e);
            }
        }

        // ===== TAB MANAGEMENT =====
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            
            // Update charts if needed
            if (tabName === 'analytics') updateAnalyticsCharts();
            if (tabName === 'projections') updateProjectionCharts();
            if (tabName === 'risk') updateRiskCharts();
            if (tabName === 'comparison') updateComparison();
        }

        // ===== PORTFOLIO MANAGEMENT =====
        function getCurrentPortfolio() {
            return portfolios[currentPortfolioId] || { name: 'Default', positions: [] };
        }

        function savePortfolios() {
            localStorage.setItem('sv_portfolios_v3', JSON.stringify(portfolios));
        }

        function switchPortfolio() {
            currentPortfolioId = document.getElementById('portfolio-selector').value;
            renderPortfolio();
            updateAllCharts();
        }

        function loadPortfolioSelector() {
            const selector = document.getElementById('portfolio-selector');
            selector.innerHTML = '';
            Object.keys(portfolios).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = portfolios[id].name;
                selector.appendChild(option);
            });
            selector.value = currentPortfolioId;
        }

        function openPortfolioManager() {
            document.getElementById('portfolio-manager-modal').classList.remove('hidden');
            renderPortfolioList();
        }

        function closePortfolioManager() {
            document.getElementById('portfolio-manager-modal').classList.add('hidden');
        }

        function createPortfolio() {
            const name = document.getElementById('new-portfolio-name').value.trim();
            if (!name) {
                alert('Por favor ingresa un nombre');
                return;
            }
            const id = Date.now().toString();
            portfolios[id] = { name, positions: [] };
            savePortfolios();
            loadPortfolioSelector();
            renderPortfolioList();
            document.getElementById('new-portfolio-name').value = '';
        }

        function deletePortfolio(id) {
            if (id === 'default') {
                alert('No puedes eliminar el portafolio principal');
                return;
            }
            if (confirm('¬øEliminar este portafolio?')) {
                delete portfolios[id];
                if (currentPortfolioId === id) currentPortfolioId = 'default';
                savePortfolios();
                loadPortfolioSelector();
                renderPortfolioList();
                renderPortfolio();
            }
        }

        function renderPortfolioList() {
            const list = document.getElementById('portfolio-list');
            list.innerHTML = Object.entries(portfolios).map(([id, pf]) => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl">
                    <div>
                        <p class="font-bold text-slate-800">${pf.name}</p>
                        <p class="text-xs text-slate-500">${pf.positions.length} posiciones</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="currentPortfolioId='${id}'; switchPortfolio(); closePortfolioManager()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold">
                            Seleccionar
                        </button>
                        ${id !== 'default' ? `<button onclick="deletePortfolio('${id}')" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-bold">Eliminar</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ===== SETTINGS =====
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-marketstack').value = MARKETSTACK_KEY;
            document.getElementById('settings-alphavantage').value = ALPHA_VANTAGE_KEY;
            document.getElementById('settings-blackbox').value = BLACKBOX_KEY;
            document.getElementById('settings-risk-free-rate').value = settings.riskFreeRate;
            document.getElementById('settings-refresh-interval').value = settings.refreshInterval;
            document.getElementById('settings-currency').value = settings.currency;
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            settings.riskFreeRate = parseFloat(document.getElementById('settings-risk-free-rate').value);
            settings.refreshInterval = parseInt(document.getElementById('settings-refresh-interval').value);
            settings.currency = document.getElementById('settings-currency').value;
            localStorage.setItem('sv_settings_v3', JSON.stringify(settings));
            alert('Configuraci√≥n guardada');
            closeSettings();
        }

        function loadSettings() {
            document.getElementById('annual-target').value = settings.annualTarget || 20;
        }

        function resetSettings() {
            if (confirm('¬øRestablecer configuraci√≥n a valores predeterminados?')) {
                settings = { riskFreeRate: 4.5, refreshInterval: 5, currency: 'USD', annualTarget: 20 };
                saveSettings();
                openSettings();
            }
        }

        // ===== PORTFOLIO RENDERING =====
        function renderPortfolio() {
            const portfolio = getCurrentPortfolio();
            const body = document.getElementById('portfolio-body');
            
            if (portfolio.positions.length === 0) {
                body.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">No hay posiciones. Haz clic en "Agregar" para comenzar.</td></tr>';
                updateKPIs({ total: 0, cost: 0, beta: 0, yield: 0 });
                return;
            }

            let stats = { total: 0, cost: 0, beta: 0, yield: 0, dgr: 0 };
            
            body.innerHTML = portfolio.positions.map(pos => {
                const value = pos.shares * pos.currentPrice;
                const gainPct = ((pos.currentPrice - pos.avgCost) / pos.avgCost * 100).toFixed(2);
                stats.total += value;
                stats.cost += pos.shares * pos.avgCost;
                stats.beta += pos.beta * value;
                stats.yield += pos.dividendYield * value;
                
                const weight = 0; // Will calculate after
                
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3">
                            <div>
                                <p class="font-black text-slate-800">${pos.ticker}</p>
                                <p class="text-[9px] text-slate-400">${pos.sector || 'N/A'}</p>
                            </div>
                        </td>
                        <td class="p-3 text-right font-bold">${pos.shares.toFixed(2)}</td>
                        <td class="p-3 text-right font-bold">$${pos.currentPrice.toFixed(2)}</td>
                        <td class="p-3 text-right font-bold">$${value.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${gainPct >= 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}">
                                ${gainPct >= 0 ? '+' : ''}${gainPct}%
                            </span>
                        </td>
                        <td class="p-3 text-center" data-weight="${pos.ticker}">--</td>
                        <td class="p-3 text-center">
                            <button onclick="removePosition('${pos.ticker}')" class="text-rose-600 hover:bg-rose-50 px-2 py-1 rounded-lg">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update weights
            portfolio.positions.forEach(pos => {
                const value = pos.shares * pos.currentPrice;
                const weight = ((value / stats.total) * 100).toFixed(1);
                const cell = document.querySelector(`[data-weight="${pos.ticker}"]`);
                if (cell) cell.textContent = `${weight}%`;
            });
            
            updateKPIs(stats);
        }

        function updateKPIs(stats) {
            const total = stats.total;
            const avgBeta = total > 0 ? stats.beta / total : 0;
            const annualTarget = parseFloat(document.getElementById('annual-target').value);
            const weeklyTarget = Math.pow(1 + annualTarget/100, 1/52) - 1;
            const weeklyValue = total * weeklyTarget;
            
            document.getElementById('kpi-total').textContent = `$${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('kpi-weekly').textContent = `+$${weeklyValue.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('kpi-weekly-pct').textContent = `${(weeklyTarget * 100).toFixed(2)}%`;
            document.getElementById('kpi-beta').textContent = avgBeta.toFixed(2);
            document.getElementById('kpi-beta-label').textContent = avgBeta < 0.85 ? 'Bajo Riesgo' : avgBeta < 1.2 ? 'Riesgo Medio' : 'Alto Riesgo';
            
            // Calculate Sharpe (simplified)
            const expectedReturn = annualTarget;
            const volatility = avgBeta * 15; // Simplified
            const sharpe = (expectedReturn - settings.riskFreeRate) / volatility;
            document.getElementById('kpi-sharpe').textContent = sharpe.toFixed(2);
            
            // Diversification (unique sectors)
            const portfolio = getCurrentPortfolio();
            const sectors = new Set(portfolio.positions.map(p => p.sector || 'Other'));
            document.getElementById('kpi-diversification').textContent = sectors.size;
            document.getElementById('kpi-div-label').textContent = `${sectors.size} Sectores`;
        }

        // ===== ADD/REMOVE POSITIONS =====
        function toggleModal() {
            document.getElementById('add-position-modal').classList.toggle('hidden');
        }

        document.getElementById('add-position-form').onsubmit = (e) => {
            e.preventDefault();
            const ticker = document.getElementById('add-ticker').value.toUpperCase();
            const shares = parseFloat(document.getElementById('add-shares').value);
            const cost = parseFloat(document.getElementById('add-cost').value);
            
            const portfolio = getCurrentPortfolio();
            portfolio.positions.push({
                ticker,
                shares,
                avgCost: cost,
                currentPrice: cost, // Will update
                beta: 1.0,
                dgr: 5.0,
                dividendYield: 2.0,
                sector: 'Other'
            });
            
            savePortfolios();
            renderPortfolio();
            updateAllCharts();
            toggleModal();
            e.target.reset();
        };

        function removePosition(ticker) {
            if (confirm(`¬øEliminar ${ticker}?`)) {
                const portfolio = getCurrentPortfolio();
                portfolio.positions = portfolio.positions.filter(p => p.ticker !== ticker);
                savePortfolios();
                renderPortfolio();
                updateAllCharts();
            }
        }

        // ===== CHARTS =====
        function updateAllCharts() {
            updateDiversificationChart();
            updateTopPerformers();
        }

        function updateDiversificationChart() {
            const ctx = document.getElementById('diversification-chart').getContext('2d');
            const portfolio = getCurrentPortfolio();
            
            if (portfolio.positions.length === 0) return;
            
            const sectorData = {};
            portfolio.positions.forEach(pos => {
                const sector = pos.sector || 'Other';
                const value = pos.shares * pos.currentPrice;
                sectorData[sector] = (sectorData[sector] || 0) + value;
            });
            
            if (charts.diversification) charts.diversification.destroy();
            
            charts.diversification = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sectorData),
                    datasets: [{
                        data: Object.values(sectorData),
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#3b82f6', '#ec4899', '#8b5cf6', '#14b8a6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 10, weight: 'bold' } } }
                    }
                }
            });
        }

        function updateTopPerformers() {
            const portfolio = getCurrentPortfolio();
            const sorted = [...portfolio.positions]
                .map(pos => ({
                    ticker: pos.ticker,
                    gain: ((pos.currentPrice - pos.avgCost) / pos.avgCost * 100)
                }))
                .sort((a, b) => b.gain - a.gain);
            
            const top3 = sorted.slice(0, 3);
            const bottom3 = sorted.slice(-3).reverse();
            
            const html = `
                <div class="space-y-1">
                    <p class="text-xs font-black text-emerald-600 uppercase mb-2">üîù Top 3</p>
                    ${top3.map(p => `
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-bold">${p.ticker}</span>
                            <span class="text-emerald-600 font-bold">+${p.gain.toFixed(2)}%</span>
                        </div>
                    `).join('')}
                </div>
                <div class="space-y-1 mt-4">
                    <p class="text-xs font-black text-rose-600 uppercase mb-2">üîª Bottom 3</p>
                    ${bottom3.map(p => `
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-bold">${p.ticker}</span>
                            <span class="text-rose-600 font-bold">${p.gain.toFixed(2)}%</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('top-performers').innerHTML = html;
        }

        // ===== ANALYTICS CHARTS =====
        function updateAnalyticsCharts() {
            updateSectorBarChart();
            updateRiskReturnScatter();
            updateCorrelationMatrix();
        }

        function updateSectorBarChart() {
            const ctx = document.getElementById('sector-bar-chart').getContext('2d');
            const portfolio = getCurrentPortfolio();
            
            const sectorData = {};
            let total = 0;
            
            portfolio.positions.forEach(pos => {
                const sector = pos.sector || 'Other';
                const value = pos.shares * pos.currentPrice;
                sectorData[sector] = (sectorData[sector] || 0) + value;
                total += value;
            });
            
            const sectors = Object.keys(sectorData);
            const values = Object.values(sectorData);
            const percentages = values.map(v => (v/total*100).toFixed(1));
            
            if (charts.sectorBar) charts.sectorBar.destroy();
            
            charts.sectorBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sectors,
                    datasets: [{
                        label: 'Valor ($)',
                        data: values,
                        backgroundColor: '#6366f1',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.y.toLocaleString()} (${percentages[ctx.dataIndex]}%)`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { callback: v => '$' + v.toLocaleString() }
                        }
                    }
                }
            });
        }

        function updateRiskReturnScatter() {
            const ctx = document.getElementById('risk-return-chart').getContext('2d');
            const portfolio = getCurrentPortfolio();
            
            const data = portfolio.positions.map(pos => ({
                x: pos.beta, // Risk (Beta)
                y: ((pos.currentPrice - pos.avgCost) / pos.avgCost * 100), // Return %
                label: pos.ticker
            }));
            
            if (charts.riskReturn) charts.riskReturn.destroy();
            
            charts.riskReturn = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Posiciones',
                        data: data,
                        backgroundColor: '#6366f1',
                        borderColor: '#4f46e5',
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${data[ctx.dataIndex].label}: Beta ${ctx.parsed.x.toFixed(2)}, Retorno ${ctx.parsed.y.toFixed(2)}%`
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Riesgo (Beta)' } },
                        y: { title: { display: true, text: 'Retorno (%)' } }
                    }
                }
            });
        }

        function updateCorrelationMatrix() {
            const ctx = document.getElementById('correlation-chart').getContext('2d');
            const portfolio = getCurrentPortfolio();
            
            // Simplified correlation (would need real historical data)
            const tickers = portfolio.positions.map(p => p.ticker);
            const correlationData = [];
            
            tickers.forEach((t1, i) => {
                tickers.forEach((t2, j) => {
                    // Simulate correlation (-1 to 1)
                    const correlation = i === j ? 1 : Math.random() * 0.8 - 0.4;
                    correlationData.push({
                        x: t2,
                        y: t1,
                        v: correlation
                    });
                });
            });
            
            if (charts.correlation) charts.correlation.destroy();
            
            // Note: This would require a heatmap plugin or custom implementation
            // For now, show a simple placeholder
            document.getElementById('correlation-chart').parentElement.innerHTML = `
                <div class="flex items-center justify-center h-96 text-slate-400">
                    <div class="text-center">
                        <i class="fa-solid fa-chart-simple text-6xl mb-4"></i>
                        <p class="text-sm">Matriz de correlaci√≥n requiere datos hist√≥ricos completos</p>
                        <p class="text-xs mt-2">Implementaci√≥n pendiente con Chart.js Matrix plugin</p>
                    </div>
                </div>
            `;
        }

        // ===== PROJECTION CHARTS =====
        function updateProjectionCharts() {
            updateMultiScenarioChart();
            updateMonthlyChart();
        }

        function updateMultiScenarioChart() {
            const ctx = document.getElementById('projection-chart').getContext('2d');
            const portfolio = getCurrentPortfolio();
            
            const total = portfolio.positions.reduce((sum, pos) => sum + (pos.shares * pos.currentPrice), 0);
            const annualTarget = parseFloat(document.getElementById('annual-target').value) / 100;
            const weeks = parseInt(document.getElementById('projection-weeks').value);
            const scenario = document.getElementById('scenario-type').value;
            
            // Calculate weekly rates for different scenarios
            const baseWeeklyRate = Math.pow(1 + annualTarget, 1/52) - 1;
            const rates = {
                optimistic: Math.pow(1 + annualTarget * 1.1, 1/52) - 1,
                base: baseWeeklyRate,
                pessimistic: Math.pow(1 + annualTarget * 0.9, 1/52) - 1
            };
            
            const labels = Array.from({length: weeks + 1}, (_, i) => `Sem ${i}`);
            
            const datasets = [
                {
                    label: 'Optimista',
                    data: Array.from({length: weeks + 1}, (_, i) => total * Math.pow(1 + rates.optimistic, i)),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false
                },
                {
                    label: 'Base',
                    data: Array.from({length: weeks + 1}, (_, i) => total * Math.pow(1 + rates.base, i)),
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 3,
                    fill: true
                },
                {
                    label: 'Pesimista',
                    data: Array.from({length: weeks + 1}, (_, i) => total * Math.pow(1 + rates.pessimistic, i)),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false
                }
            ];
            
            if (charts.projection) charts.projection.destroy();
            
            charts.projection = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            ticks: { callback: v => '$' + v.toLocaleString() },
                            grid: { color: '#f1f5f9' }
                        },
                        x: { 
                            ticks: { 
                                maxTicksLimit: 12,
                                callback: (val, index) => index % 4 === 0 ? labels[index] : ''
                            }
                        }
                    }
                }
            });
        }

        function updateMonthlyChart() {
            const ctx = document.getElementById('monthly-projection-chart').getContext('2d');
            const portfolio = getCurrentPortfolio();
            
            const total = portfolio.positions.reduce((sum, pos) => sum + (pos.shares * pos.currentPrice), 0);
            const annualTarget = parseFloat(document.getElementById('annual-target').value) / 100;
            const monthlyRate = Math.pow(1 + annualTarget, 1/12) - 1;
            
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const values = Array.from({length: 12}, (_, i) => total * Math.pow(1 + monthlyRate, i + 1));
            const gains = values.map(v => v - total);
            
            if (charts.monthly) charts.monthly.destroy();
            
            charts.monthly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Ganancia Proyectada',
                        data: gains,
                        backgroundColor: gains.map(g => g >= 0 ? '#10b981' : '#ef4444'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Ganancia: $${ctx.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { callback: v => '$' + v.toLocaleString() }
                        }
                    }
                }
            });
        }

        // ===== RISK CHARTS =====
        function updateRiskCharts() {
            updateRiskMetrics();
            updateBetaDistribution();
            updateConcentrationRisk();
        }

        function updateRiskMetrics() {
            const portfolio = getCurrentPortfolio();
            let total = 0;
            let weightedBeta = 0;
            
            portfolio.positions.forEach(pos => {
                const value = pos.shares * pos.currentPrice;
                total += value;
                weightedBeta += pos.beta * value;
            });
            
            const avgBeta = total > 0 ? weightedBeta / total : 0;
            const annualTarget = parseFloat(document.getElementById('annual-target').value);
            
            // Simplified metrics (would need historical data for accuracy)
            const volatility = (avgBeta * 15).toFixed(2); // Simplified: Beta * market vol
            const sharpe = ((annualTarget - settings.riskFreeRate) / parseFloat(volatility)).toFixed(2);
            const sortino = (sharpe * 1.4).toFixed(2); // Simplified
            const var95 = (total * 0.05 * avgBeta).toFixed(2); // Simplified VaR
            
            document.getElementById('risk-volatility').textContent = `${volatility}%`;
            document.getElementById('risk-sharpe').textContent = sharpe;
            document.getElementById('risk-sortino').textContent = sortino;
            document.getElementById('risk-var').textContent = `$${parseFloat(var95).toLocaleString()}`;
            
            // Update KPIs
            document.getElementById('kpi-sharpe').textContent = sharpe;
            document.getElementById('kpi-sharpe-label').textContent = sharpe > 1 ? 'Excelente' : sharpe > 0.5 ? 'Bueno' : 'Regular';
            
            // Max Drawdown (simplified)
            const maxDrawdown = (avgBeta * 8).toFixed(2);
            document.getElementById('kpi-drawdown').textContent = `${maxDrawdown}%`;
        }

        function updateBetaDistribution() {
            const ctx = document.getElementById('beta-distribution-chart').getContext('2d');
            const portfolio = getCurrentPortfolio();
            
            // Group by beta ranges
            const ranges = {
                'Muy Bajo (<0.5)': 0,
                'Bajo (0.5-0.8)': 0,
                'Medio (0.8-1.2)': 0,
                'Alto (1.2-1.5)': 0,
                'Muy Alto (>1.5)': 0
            };
            
            portfolio.positions.forEach(pos => {
                const value = pos.shares * pos.currentPrice;
                if (pos.beta < 0.5) ranges['Muy Bajo (<0.5)'] += value;
                else if (pos.beta < 0.8) ranges['Bajo (0.5-0.8)'] += value;
                else if (pos.beta < 1.2) ranges['Medio (0.8-1.2)'] += value;
                else if (pos.beta < 1.5) ranges['Alto (1.2-1.5)'] += value;
                else ranges['Muy Alto (>1.5)'] += value;
            });
            
            if (charts.betaDist) charts.betaDist.destroy();
            
            charts.betaDist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Distribuci√≥n de Riesgo',
                        data: Object.values(ranges),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#991b1b'],
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.x.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { callback: v => '$' + v.toLocaleString() }
                        }
                    }
                }
            });
        }

        function updateConcentrationRisk() {
            const ctx = document.getElementById('concentration-chart').getContext('2d');
            const portfolio = getCurrentPortfolio();
            
            let total = 0;
            const values = portfolio.positions.map(pos => {
                const value = pos.shares * pos.currentPrice;
                total += value;
                return { ticker: pos.ticker, value };
            }).sort((a, b) => b.value - a.value);
            
            const topN = values.slice(0, 5);
            const othersValue = values.slice(5).reduce((sum, v) => sum + v.value, 0);
            
            const labels = topN.map(v => `${v.ticker} (${(v.value/total*100).toFixed(1)}%)`);
            const data = topN.map(v => v.value);
            
            if (othersValue > 0) {
                labels.push(`Otros (${(othersValue/total*100).toFixed(1)}%)`);
                data.push(othersValue);
            }
            
            if (charts.concentration) charts.concentration.destroy();
            
            charts.concentration = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Concentraci√≥n',
                        data: data,
                        backgroundColor: data.map((v, i) => {
                            const pct = v / total * 100;
                            if (pct > 30) return '#ef4444'; // High risk
                            if (pct > 20) return '#f59e0b'; // Medium risk
                            return '#10b981'; // Low risk
                        }),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.y.toLocaleString()} (${(ctx.parsed.y/total*100).toFixed(1)}%)`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            ticks: { callback: v => '$' + v.toLocaleString() }
                        }
                    }
                }
            });
        }

        // ===== PROJECTION CHARTS =====
        function updateProjectionCharts() {
            updateMultiScenarioChart();
            updateMonthlyChart();
        }

        function updateProjections() {
            updateProjectionCharts();
            updateKPIs(calculateStats());
        }

        function calculateStats() {
            const portfolio = getCurrentPortfolio();
            let stats = { total: 0, cost: 0, beta: 0, yield: 0, dgr: 0 };
            
            portfolio.positions.forEach(pos => {
                const value = pos.shares * pos.currentPrice;
                stats.total += value;
                stats.cost += pos.shares * pos.avgCost;
                stats.beta += pos.beta * value;
                stats.yield += pos.dividendYield * value;
                stats.dgr += (pos.dgr || 0) * value;
            });
            
            return stats;
        }

        // ===== COMPARISON =====
        function updateComparison() {
            const allPortfolios = Object.entries(portfolios);
            const comparisonHTML = `
                <div class="overflow-x-auto custom-scroll">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3 text-left font-black uppercase text-xs">Portafolio</th>
                                <th class="p-3 text-right font-black uppercase text-xs">Valor</th>
                                <th class="p-3 text-right font-black uppercase text-xs">Posiciones</th>
                                <th class="p-3 text-right font-black uppercase text-xs">Beta</th>
                                <th class="p-3 text-right font-black uppercase text-xs">Sharpe</th>
                                <th class="p-3 text-right font-black uppercase text-xs">Retorno</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allPortfolios.map(([id, pf]) => {
                                const total = pf.positions.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
                                const avgBeta = total > 0 ? pf.positions.reduce((sum, p) => sum + (p.beta * p.shares * p.currentPrice), 0) / total : 0;
                                const totalCost = pf.positions.reduce((sum, p) => sum + (p.shares * p.avgCost), 0);
                                const totalReturn = totalCost > 0 ? ((total - totalCost) / totalCost * 100) : 0;
                                const volatility = avgBeta * 15;
                                const sharpe = ((20 - settings.riskFreeRate) / volatility).toFixed(2);
                                
                                return `
                                    <tr class="border-b hover:bg-slate-50 ${id === currentPortfolioId ? 'bg-indigo-50 font-bold' : ''}">
                                        <td class="p-3 font-bold">${pf.name} ${id === currentPortfolioId ? '‚≠ê' : ''}</td>
                                        <td class="p-3 text-right font-bold">$${total.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td class="p-3 text-right">${pf.positions.length}</td>
                                        <td class="p-3 text-right">${avgBeta.toFixed(2)}</td>
                                        <td class="p-3 text-right">${sharpe}</td>
                                        <td class="p-3 text-right font-bold ${totalReturn >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
                                            ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 glass-card p-6 rounded-2xl">
                    <h4 class="font-black text-slate-700 uppercase text-xs mb-4">Comparaci√≥n Visual</h4>
                    <div class="h-64">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                </div>
            `;
            
            document.getElementById('comparison-content').innerHTML = comparisonHTML;
            
            // Render comparison chart
            setTimeout(() => renderComparisonChart(), 100);
        }

        function renderComparisonChart() {
            const ctx = document.getElementById('comparison-chart')?.getContext('2d');
            if (!ctx) return;
            
            const allPortfolios = Object.entries(portfolios);
            const names = allPortfolios.map(([id, pf]) => pf.name);
            const values = allPortfolios.map(([id, pf]) => 
                pf.positions.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0)
            );
            const betas = allPortfolios.map(([id, pf]) => {
                const total = values[allPortfolios.findIndex(([i]) => i === id)];
                return total > 0 ? pf.positions.reduce((sum, p) => sum + (p.beta * p.shares * p.currentPrice), 0) / total : 0;
            });
            
            if (charts.comparison) charts.comparison.destroy();
            
            charts.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [
                        {
                            label: 'Valor ($)',
                            data: values,
                            backgroundColor: '#6366f1',
                            borderRadius: 8,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Beta',
                            data: betas,
                            type: 'line',
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { callback: v => '$' + v.toLocaleString() },
                            title: { display: true, text: 'Valor ($)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Beta (Riesgo)' }
                        }
                    }
                }
            });
        }

        // ===== ENHANCED ADD POSITION =====
        document.getElementById('add-position-form').onsubmit = (e) => {
            e.preventDefault();
            const ticker = document.getElementById('add-ticker').value.toUpperCase();
            const shares = parseFloat(document.getElementById('add-shares').value);
            const cost = parseFloat(document.getElementById('add-cost').value);
            
            const ref = stockRef[ticker];
            const portfolio = getCurrentPortfolio();
            
            // Check if already exists
            if (portfolio.positions.find(p => p.ticker === ticker)) {
                if (!confirm(`${ticker} ya existe en el portafolio. ¬øAgregar m√°s acciones?`)) {
                    return;
                }
            }
            
            portfolio.positions.push({
                ticker,
                shares,
                avgCost: cost,
                currentPrice: cachedPrices.prices?.[ticker] || cost,
                beta: ref?.beta || 1.0,
                dgr: ref?.dgr || 5.0,
                dividendYield: ref?.yield || 2.0,
                sector: ref?.sector || 'Other',
                name: ref?.name || ticker
            });
            
            savePortfolios();
            renderPortfolio();
            updateAllCharts();
            toggleModal();
            e.target.reset();
            
            alert(`‚úÖ ${ticker} agregado correctamente`);
        };
    </script>

</body>
</html>
