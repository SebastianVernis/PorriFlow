<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SV Portfolio Manager v3.0 Unified | AI Analysis + Multi-Portfolio</title>
    <!-- Tailwind CSS (compiled) -->
    <link rel="stylesheet" href="/assets/css/output.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Authentication Module -->
    <script type="module" src="/assets/js/auth.js"></script>
    <!-- WebSocket Module -->
    <script type="module" src="/assets/js/websocket.js"></script>
    <!-- News Module -->
    <script type="module" src="/assets/js/news.js"></script>
    <style>
        .ai-pulse {
            animation: pulse-indigo 2s infinite;
        }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 font-sans min-h-screen">

    <!-- Header Navigation -->
    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-40 shadow-xl border-b border-indigo-500/30">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl ai-pulse">
                    <i class="fa-solid fa-robot text-white"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">SV <span class="text-indigo-400 font-light">Portfolio Manager v3.0</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <select id="portfolio-selector" onchange="switchPortfolio()" class="bg-slate-800 border border-indigo-500/30 rounded-xl px-3 py-2 text-sm font-bold mr-2">
                    <option value="default">Portafolio Principal</option>
                </select>
                <button onclick="openPortfolioManager()" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-xl text-sm font-bold transition-all active:scale-95 shadow-lg shadow-emerald-500/20 mr-2">
                    <i class="fa-solid fa-folder-open mr-1"></i>Gestionar
                </button>
                <button onclick="openSettings()" class="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-xl text-sm font-bold transition-all active:scale-95 mr-2">
                    <i class="fa-solid fa-sliders mr-1"></i>Config
                </button>
                <div class="hidden md:flex flex-col items-end text-right mr-4 border-r border-slate-700 pr-4">
                    <span id="update-timer" class="text-[10px] uppercase font-black text-indigo-300 tracking-widest">Next Refresh: 5:00</span>
                    <span id="cache-status" class="text-[9px] text-slate-500 font-mono">Cargando precios...</span>
                    <span id="api-source" class="text-[8px] text-indigo-400 font-mono mt-0.5">üöÄ Multi-API (Marketstack + Finnhub)</span>
                </div>
                <div id="user-display" class="hidden md:flex items-center text-sm mr-2">
                    <span class="text-slate-400">Cargando...</span>
                </div>
                <button onclick="openAIPortfolioBuilder()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 px-4 py-2 rounded-xl text-sm font-bold transition-all active:scale-95 shadow-lg shadow-purple-500/30 mr-2">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>AI Portfolio
                </button>
                <button onclick="toggleModal()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-xl text-sm font-bold transition-all active:scale-95 shadow-lg shadow-indigo-500/20">
                    <i class="fa-solid fa-plus mr-2"></i>Simular
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        
        <!-- Tabs Navigation -->
        <div class="flex gap-2 mb-6 bg-white rounded-2xl p-2 shadow-sm overflow-x-auto custom-scroll">
            <button onclick="switchTab('main')" id="tab-main" class="tab-active px-4 py-2 rounded-xl font-bold text-xs whitespace-nowrap transition-all">
                <i class="fa-solid fa-gauge mr-1"></i>Principal
            </button>
            <button onclick="switchTab('projections')" id="tab-projections" class="px-4 py-2 rounded-xl font-bold text-xs whitespace-nowrap transition-all hover:bg-slate-50">
                <i class="fa-solid fa-chart-line mr-1"></i>Proyecciones
            </button>
            <button onclick="switchTab('risk')" id="tab-risk" class="px-4 py-2 rounded-xl font-bold text-xs whitespace-nowrap transition-all hover:bg-slate-50">
                <i class="fa-solid fa-shield-halved mr-1"></i>Riesgo
            </button>
            <button onclick="switchTab('comparison')" id="tab-comparison" class="px-4 py-2 rounded-xl font-bold text-xs whitespace-nowrap transition-all hover:bg-slate-50">
                <i class="fa-solid fa-code-compare mr-1"></i>Comparar
            </button>
            <button onclick="switchTab('news')" id="tab-news" class="px-4 py-2 rounded-xl font-bold text-xs whitespace-nowrap transition-all hover:bg-slate-50">
                <i class="fa-solid fa-newspaper mr-1"></i>Noticias
            </button>
        </div>

        <!-- TAB CONTENT: Main -->
        <div id="content-main" class="tab-content">
        
        <!-- Summary Dashboard -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
            <div class="glass-card p-5 rounded-3xl shadow-sm border-b-4 border-indigo-500">
                <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Valor Portafolio</p>
                <h2 id="total-value" class="text-2xl font-black text-slate-800">$0.00</h2>
                <p id="total-gain-loss" class="text-xs font-bold mt-1 text-slate-400">Sincronizando...</p>
            </div>
            <div class="glass-card p-5 rounded-3xl shadow-sm border-b-4 border-emerald-500">
                <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Meta 7 D√≠as</p>
                <h2 id="weekly-target" class="text-2xl font-black text-emerald-600">+$0.00</h2>
                <p class="text-[10px] text-slate-400 mt-1 font-bold uppercase italic">Crecimiento: 0.35%</p>
            </div>
            <div class="glass-card p-5 rounded-3xl shadow-sm border-b-4 border-amber-400">
                <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Elasticidad (Beta)</p>
                <h2 id="portfolio-beta" class="text-2xl font-black text-slate-800">0.00</h2>
                <p id="beta-status" class="text-[10px] text-slate-400 mt-1 font-bold">Risk Analysis</p>
            </div>
            <div class="glass-card p-5 rounded-3xl shadow-sm border-b-4 border-indigo-400">
                <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Proyecci√≥n 12M</p>
                <h2 id="projection-return" class="text-2xl font-black text-indigo-700">20.0%+</h2>
                <p class="text-[10px] text-slate-400 mt-1 font-bold">SV Strategy Goal</p>
            </div>
            <div class="glass-card p-5 rounded-3xl shadow-sm border-b-4 border-purple-500">
                <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Sharpe Ratio</p>
                <h2 id="sharpe-ratio" class="text-2xl font-black text-slate-800">0.00</h2>
                <p id="sharpe-status" class="text-[10px] text-slate-400 mt-1 font-bold">Risk/Return</p>
            </div>
            <div class="glass-card p-5 rounded-3xl shadow-sm border-b-4 border-rose-500">
                <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Max Drawdown</p>
                <h2 id="max-drawdown" class="text-2xl font-black text-slate-800">0.00%</h2>
                <p class="text-[10px] text-slate-400 mt-1 font-bold">P√©rdida M√°x</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Side: Table & Charts -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Weekly Projection Chart -->
                <div class="glass-card p-6 rounded-3xl shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-slate-700 uppercase text-xs tracking-tighter">Proyecci√≥n de Crecimiento Semanal</h3>
                        <div class="flex gap-2">
                            <span class="px-2 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-black">Escenario Corto Plazo</span>
                        </div>
                    </div>
                    <div class="relative h-64">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>

                <!-- Assets Table -->
                <div class="glass-card rounded-3xl shadow-sm overflow-hidden border border-slate-100">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white/50">
                        <h3 class="font-black text-slate-700 uppercase text-xs tracking-tighter">Posiciones y An√°lisis Semanal</h3>
                        <div class="flex gap-2 items-center">
                            <span id="live-indicator" class="w-2 h-2 rounded-full bg-slate-300"></span>
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Alpha Vantage Sync</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto custom-scroll">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50/50 text-slate-400 text-[10px] uppercase font-black border-b border-slate-100">
                                <tr>
                                    <th class="p-4 text-left">Activo</th>
                                    <th class="p-4 text-right">Cantidad</th>
                                    <th class="p-4 text-right">Precio</th>
                                    <th class="p-4 text-right">Valor</th>
                                    <th class="p-4 text-center">Rend. %</th>
                                    <th class="p-4 text-center">Beta</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-body" class="divide-y divide-slate-100">
                                <!-- JS Injection -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Side: Blackbox AI Strategy Panel -->
            <div class="space-y-6">
                <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden group border border-indigo-500/20">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-600/10 rounded-full blur-3xl group-hover:bg-indigo-600/20 transition-all duration-1000"></div>
                    
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                            <i class="fa-solid fa-bolt-lightning text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-black text-white uppercase text-xs tracking-widest">Forecast Semanal</h3>
                            <p class="text-[9px] text-indigo-400 font-bold uppercase tracking-tighter">BlackboxAI Engine Pro</p>
                        </div>
                    </div>

                    <div id="ai-insight-container" class="space-y-4">
                        <div id="ai-loader" class="hidden py-10 flex flex-col items-center justify-center space-y-3">
                            <div class="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-[10px] font-black uppercase tracking-widest text-indigo-400">Consultando Blackbox API...</span>
                        </div>
                        <div id="ai-content" class="text-sm text-slate-300 leading-relaxed min-h-[150px]">
                            Selecciona "Analizar" en un activo para proyectar su comportamiento en los pr√≥ximos 7 d√≠as bas√°ndose en su elasticidad actual.
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-white/5">
                        <button onclick="getGlobalForecast()" class="w-full bg-white/5 hover:bg-white/10 text-white font-bold py-3 rounded-2xl border border-white/10 transition-all text-[10px] uppercase tracking-widest">
                            An√°lisis Global Semanal
                        </button>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-3xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs tracking-tighter mb-4">Diversificaci√≥n Sectorial</h3>
                    <div class="relative h-48">
                        <canvas id="diversificationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- END TAB: Main -->

        <!-- TAB CONTENT: Projections -->
        <div id="content-projections" class="tab-content hidden">
            <div class="glass-card p-6 rounded-2xl shadow-sm mb-6">
                <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Par√°metros de Proyecci√≥n</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-600 mb-2">Meta Anual (%)</label>
                        <input type="number" id="annual-target-input" value="20" step="1" min="1" max="100" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-600 mb-2">Horizonte (sem)</label>
                        <input type="number" id="projection-weeks" value="52" step="1" min="4" max="104" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-600 mb-2">Escenario</label>
                        <select id="scenario-type" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold">
                            <option value="optimistic">Optimista</option>
                            <option value="base" selected>Base</option>
                            <option value="pessimistic">Pesimista</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-600 mb-2">Volatilidad</label>
                        <input type="number" id="market-volatility" value="15" step="1" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold">
                    </div>
                    <div class="flex items-end">
                        <button onclick="updateAllProjections()" class="w-full bg-indigo-600 text-white rounded-xl p-3 text-sm font-bold hover:bg-indigo-700">
                            <i class="fa-solid fa-rotate mr-1\"></i>Actualizar
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Proyecci√≥n Multi-Escenario</h3>
                    <div class="h-96">
                        <canvas id="multi-scenario-chart"></canvas>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Desglose Mensual</h3>
                    <div class="h-64">
                        <canvas id="monthly-breakdown-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB CONTENT: Risk -->
        <div id="content-risk" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-card p-5 rounded-2xl shadow-sm">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Volatilidad</p>
                    <h3 id="risk-volatility" class="text-xl font-black text-slate-800">0.00%</h3>
                </div>
                <div class="glass-card p-5 rounded-2xl shadow-sm">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Sharpe Ratio</p>
                    <h3 id="risk-sharpe" class="text-xl font-black text-slate-800">0.00</h3>
                </div>
                <div class="glass-card p-5 rounded-2xl shadow-sm">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Sortino Ratio</p>
                    <h3 id="risk-sortino" class="text-xl font-black text-slate-800">0.00</h3>
                </div>
                <div class="glass-card p-5 rounded-2xl shadow-sm">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">VaR (95%)</p>
                    <h3 id="risk-var" class="text-xl font-black text-rose-600">$0.00</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Distribuci√≥n de Beta</h3>
                    <div class="h-80">
                        <canvas id="beta-distribution-chart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-2xl shadow-sm">
                    <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Riesgo de Concentraci√≥n</h3>
                    <div class="h-80">
                        <canvas id="concentration-risk-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB CONTENT: Comparison -->
        <div id="content-comparison" class="tab-content hidden">
            <div class="glass-card p-6 rounded-2xl shadow-sm">
                <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Comparaci√≥n de Portafolios</h3>
                <div id="comparison-table-container">
                    <p class="text-slate-400 text-sm text-center py-8">Crea m√∫ltiples portafolios para compararlos</p>
                </div>
            </div>
            <div class="glass-card p-6 rounded-2xl shadow-sm mt-6">
                <h3 class="font-black text-slate-700 uppercase text-xs mb-4">Comparaci√≥n Visual</h3>
                <div class="h-80">
                    <canvas id="portfolio-comparison-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB CONTENT: News -->
        <div id="content-news" class="tab-content hidden">
            <div class="glass-card p-6 rounded-2xl shadow-sm mb-6">
                <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                    <div>
                        <h3 class="font-black text-slate-700 uppercase text-xs mb-1">
                            <i class="fa-solid fa-newspaper text-indigo-600 mr-2"></i>Noticias Financieras
                            <span id="ws-status" class="ml-2 text-[9px] px-2 py-1 rounded-full bg-slate-200 text-slate-600">Conectando...</span>
                        </h3>
                        <p class="text-xs text-slate-500">√öltimas noticias de tu portafolio</p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <!-- Filtros -->
                        <select id="news-type-filter" onchange="applyNewsFilters()" class="bg-slate-100 border border-slate-300 rounded-lg px-3 py-1.5 text-xs font-bold">
                            <option value="">Todos los tipos</option>
                            <option value="article">Art√≠culos</option>
                            <option value="earnings">Earnings</option>
                            <option value="dividend">Dividendos</option>
                            <option value="filing">Filings</option>
                            <option value="merger">Fusiones/Adq.</option>
                        </select>
                        <select id="news-sentiment-filter" onchange="applyNewsFilters()" class="bg-slate-100 border border-slate-300 rounded-lg px-3 py-1.5 text-xs font-bold">
                            <option value="">Todos los sentimientos</option>
                            <option value="positive">üìà Positivo</option>
                            <option value="negative">üìâ Negativo</option>
                            <option value="neutral">‚ûñ Neutral</option>
                        </select>
                        <button onclick="refreshPortfolioNews()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition-all">
                            <i class="fa-solid fa-rotate mr-1"></i>Actualizar
                        </button>
                    </div>
                </div>
                
                <div id="portfolio-news-feed">
                    <div class="flex items-center justify-center p-12">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                            <p class="text-sm text-slate-500 font-bold">Cargando noticias...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- AI Portfolio Builder Modal -->
    <div id="ai-portfolio-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-purple-900 to-slate-900 rounded-[2.5rem] shadow-2xl w-full max-w-4xl p-8 border border-purple-500/30 relative overflow-hidden">
            <div class="absolute -right-20 -top-20 w-80 h-80 bg-purple-600/20 rounded-full blur-3xl animate-pulse"></div>
            
            <div class="flex justify-between items-start mb-6 relative z-10">
                <div class="flex items-center gap-3">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-purple-500/50">
                        <i class="fa-solid fa-wand-magic-sparkles text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-3xl font-black text-white tracking-tight">AI Portfolio Builder</h3>
                        <p class="text-sm text-purple-300 font-bold uppercase tracking-wider mt-1">Recomendaci√≥n Inteligente de Inversi√≥n</p>
                    </div>
                </div>
                <button onclick="closeAIPortfolioModal()" class="text-slate-400 hover:text-rose-400 transition-colors text-2xl">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>

            <div id="ai-portfolio-form" class="relative z-10 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-black uppercase text-purple-300 mb-2">Capital de Inversi√≥n ($)</label>
                        <input type="number" id="portfolio-capital" step="1000" value="10000" required class="w-full bg-slate-800/50 border border-purple-500/30 rounded-xl p-4 font-bold text-white outline-none focus:ring-2 focus:ring-purple-500/50 transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-black uppercase text-purple-300 mb-2">Perfil de Riesgo</label>
                        <select id="portfolio-risk" class="w-full bg-slate-800/50 border border-purple-500/30 rounded-xl p-4 font-bold text-white outline-none focus:ring-2 focus:ring-purple-500/50 transition-all">
                            <option value="conservative">Conservador (Beta < 0.7)</option>
                            <option value="moderate" selected>Moderado (Beta 0.7-1.2)</option>
                            <option value="aggressive">Agresivo (Beta > 1.2)</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-black uppercase text-purple-300 mb-2">Objetivo de Inversi√≥n</label>
                    <select id="portfolio-goal" class="w-full bg-slate-800/50 border border-purple-500/30 rounded-xl p-4 font-bold text-white outline-none focus:ring-2 focus:ring-purple-500/50 transition-all">
                        <option value="dividend">Ingresos por Dividendos (Yield Alto)</option>
                        <option value="growth" selected>Crecimiento de Capital (DGR Alto)</option>
                        <option value="balanced">Balanceado (Dividendos + Crecimiento)</option>
                    </select>
                </div>

                <button onclick="generateAIPortfolio()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-black py-5 rounded-2xl transition-all shadow-xl shadow-purple-500/30 uppercase tracking-widest text-sm">
                    <i class="fa-solid fa-sparkles mr-2"></i>Generar Portafolio con IA
                </button>
            </div>

            <div id="ai-portfolio-loader" class="hidden py-16 flex flex-col items-center justify-center space-y-4 relative z-10">
                <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-sm font-black uppercase tracking-widest text-purple-300">Analizando mercado con BlackboxAI...</span>
                <p class="text-xs text-slate-400">Evaluando 70+ s√≠mbolos y optimizando diversificaci√≥n</p>
            </div>

            <div id="ai-portfolio-result" class="hidden relative z-10 mt-6 space-y-4">
                <div class="bg-slate-800/50 rounded-2xl p-6 border border-purple-500/20">
                    <h4 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-purple-400"></i>
                        Recomendaci√≥n de Portafolio
                    </h4>
                    <div id="ai-portfolio-content" class="text-slate-200 text-sm leading-relaxed space-y-3 max-h-[40vh] overflow-y-auto custom-scroll">
                        <!-- AI Response -->
                    </div>
                </div>

                <div class="bg-slate-800/50 rounded-2xl p-6 border border-purple-500/20">
                    <h4 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-emerald-400"></i>
                        S√≠mbolos Recomendados
                    </h4>
                    <div id="ai-portfolio-symbols" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <!-- Symbols will be injected -->
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="applyAIPortfolio()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-2xl transition-all shadow-lg uppercase tracking-widest text-sm">
                        <i class="fa-solid fa-check-circle mr-2"></i>Aplicar al Portafolio
                    </button>
                    <button onclick="closeAIPortfolioModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-2xl transition-all uppercase tracking-widest text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-slate-900 rounded-[2.5rem] shadow-2xl w-full max-w-3xl p-8 border border-indigo-500/30 relative overflow-hidden">
            <div class="absolute -right-20 -top-20 w-60 h-60 bg-indigo-600/10 rounded-full blur-3xl"></div>
            
            <div class="flex justify-between items-start mb-6 relative z-10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                        <i class="fa-solid fa-brain text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-white tracking-tight">An√°lisis AI Enriquecido</h3>
                        <p id="ai-modal-ticker" class="text-sm text-indigo-400 font-bold uppercase tracking-wider mt-1"></p>
                        <p class="text-[9px] text-slate-500 mt-0.5">Con datos hist√≥ricos, noticias y sentimiento del mercado</p>
                    </div>
                </div>
                <button onclick="closeAIModal()" class="text-slate-400 hover:text-rose-400 transition-colors text-2xl">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>

            <div id="ai-modal-loader" class="hidden py-16 flex flex-col items-center justify-center space-y-4 relative z-10">
                <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-sm font-black uppercase tracking-widest text-indigo-400">Consultando BlackboxAI...</span>
                <p class="text-xs text-slate-400">Recopilando datos hist√≥ricos, noticias y sentimiento...</p>
            </div>

            <div id="ai-modal-content" class="relative z-10 bg-slate-800/50 rounded-2xl p-6 text-slate-200 leading-relaxed min-h-[200px] max-h-[60vh] overflow-y-auto custom-scroll">
                <!-- Content injected by JS -->
            </div>

            <div class="mt-6 flex gap-3 relative z-10">
                <button onclick="closeAIModal()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-2xl border border-slate-700 transition-all text-sm uppercase tracking-widest">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Chart Popup Hover -->
    <div id="chart-popup" class="chart-popup">
        <div class="bg-slate-900 rounded-2xl shadow-2xl border border-indigo-500/30 p-4 w-[400px]">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h4 id="popup-ticker" class="text-lg font-black text-white"></h4>
                    <p id="popup-name" class="text-xs text-slate-400"></p>
                </div>
                <div id="popup-loader" class="hidden">
                    <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>
            <div class="relative h-[200px] bg-slate-800/50 rounded-xl p-2">
                <canvas id="popup-chart"></canvas>
            </div>
            <div id="popup-stats" class="grid grid-cols-3 gap-2 mt-3 text-center">
                <!-- Stats injected by JS -->
            </div>
        </div>
    </div>

    <!-- Simulation Modal -->
    <div id="sim-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-md p-8 border border-slate-100">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-2xl font-black text-slate-800 tracking-tighter">Simular Activo</h3>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-1">Algoritmo de Proyecci√≥n Semanal</p>
                </div>
                <button onclick="toggleModal()" class="text-slate-300 hover:text-rose-500 transition-colors text-2xl">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>
            <form id="sim-form" class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black uppercase text-indigo-600 mb-1 ml-1">Ticker (S√≠mbolo)</label>
                    <select id="sim-ticker" required class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-black uppercase text-slate-800 outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all">
                        <option value="">Selecciona un s√≠mbolo...</option>
                    </select>
                    <div id="ticker-price-info" class="mt-2 text-xs text-slate-500 font-bold hidden">
                        <span id="ticker-current-price"></span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-indigo-600 mb-1 ml-1">Cantidad</label>
                        <input type="number" id="sim-shares" step="0.01" required class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-black text-slate-800">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase text-indigo-600 mb-1 ml-1">Costo Promedio</label>
                        <input type="number" id="sim-cost" step="0.01" required class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 font-black text-slate-800">
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-black py-5 rounded-[1.5rem] hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-500/20 uppercase tracking-widest active:scale-95">
                    Integrar al Monitor
                </button>
            </form>
        </div>
    </div>

    <!-- Portfolio Manager Modal -->
    <div id="portfolio-manager-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">Gesti√≥n de Portafolios</h3>
                <button onclick="closePortfolioManager()" class="text-slate-400 hover:text-rose-500 text-2xl">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex gap-3">
                    <input type="text" id="new-portfolio-name" placeholder="Nombre del nuevo portafolio" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold">
                    <button onclick="createNewPortfolio()" class="bg-emerald-600 text-white px-6 rounded-xl font-bold hover:bg-emerald-700">
                        <i class="fa-solid fa-plus mr-2"></i>Crear
                    </button>
                </div>
                
                <div id="portfolio-list-container" class="space-y-2 max-h-96 overflow-y-auto custom-scroll">
                    <!-- Portfolio list injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-3xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">Configuraci√≥n Global</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-rose-500 text-2xl">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h4 class="font-black text-slate-700 uppercase text-xs">Preferencias de C√°lculo</h4>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Tasa Libre de Riesgo (%)</label>
                        <input type="number" id="settings-risk-free-rate" value="4.5" step="0.1" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold">
                        <p class="text-xs text-slate-400 mt-1">Referencia: T-Bills USA 10Y (~4-5%)</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Intervalo de Actualizaci√≥n (min)</label>
                        <input type="number" id="settings-refresh-interval" value="5" step="1" min="1" max="60" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Volatilidad de Mercado (%)</label>
                        <input type="number" id="settings-market-vol" value="15" step="1" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold">
                        <p class="text-xs text-slate-400 mt-1">S&P 500 promedio hist√≥rico: 15%</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <h4 class="font-black text-slate-700 uppercase text-xs">Informaci√≥n del Sistema</h4>
                    <div class="bg-slate-50 p-4 rounded-xl space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-600">Versi√≥n:</span>
                            <span class="font-bold">v3.0 Unified</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Portafolios:</span>
                            <span class="font-bold" id="settings-portfolio-count">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Cache precios:</span>
                            <span class="font-bold" id="settings-cache-count">0 s√≠mbolos</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">API Status:</span>
                            <span class="font-bold text-emerald-600">‚úÖ Operacional</span>
                        </div>
                    </div>
                    
                    <button onclick="clearAllData()" class="w-full bg-rose-600 text-white py-3 rounded-xl text-sm font-bold hover:bg-rose-700">
                        <i class="fa-solid fa-trash mr-2"></i>Limpiar Todos los Datos
                    </button>
                    <p class="text-xs text-slate-400 text-center">‚ö†Ô∏è Esto borrar√° todos los portafolios y configuraci√≥n</p>
                </div>
            </div>
            
            <div class="mt-6 flex gap-3">
                <button onclick="saveGlobalSettings()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">
                    <i class="fa-solid fa-floppy-disk mr-2"></i>Guardar Cambios
                </button>
                <button onclick="closeSettings()" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold hover:bg-slate-300">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * SV PORTFOLIO DASHBOARD v3.0 UNIFIED - COMPLETE SOLUTION
         * AI Analysis + Multi-Portfolio + Advanced Analytics
         * Author: Sebastian Vernis Environment
         * 
         * Features:
         * - Real-time prices with Multi-API fallback (Marketstack ‚Üí Finnhub ‚Üí Alpha Vantage)
         * - Enhanced AI analysis with Finnhub fundamentals & sentiment
         * - Historical data with hover charts
         * - AI analysis with news sentiment
         * - Weekly projection tracking
         * - Smart caching with fallback
         */

        // --- ESTRUCTURA DE API KEYS ---
        const ALPHA_VANTAGE_KEY = "CJIOJ9QSU8A2JM7R"; 
        const MARKETSTACK_API_KEY = "68b8070ec719075f3ea37d9069d4ea68";
        const FINNHUB_API_KEY = "d5fjbopr01qnjhoclpjgd5fjbopr01qnjhoclpk0";
        const BLACKBOX_API_KEY = "sk-Vl6HBMkEaEzvj6x_qfrfhA";
        const MARKETAUX_API_KEY = ""; // Obtener en: https://www.marketaux.com/

        // --- MULTI-PORTFOLIO SYSTEM v3.0 ---
        let currentPortfolioId = 'default';
        let portfolios = JSON.parse(localStorage.getItem('sv_portfolios_unified')) || {
            'default': {
                name: 'Portafolio Principal',
                positions: JSON.parse(localStorage.getItem('sv_dividend_portfolio')) || []
            }
        };
        
        let globalSettings = JSON.parse(localStorage.getItem('sv_global_settings')) || {
            riskFreeRate: 4.5,
            refreshInterval: 5,
            marketVolatility: 15,
            annualTarget: 20
        };
        
        let portfolio = portfolios[currentPortfolioId]?.positions || [];
        let timeLeft = 300;
        let chartInstances = { weekly: null, diversification: null, popup: null, multiScenario: null, monthly: null, betaDist: null, concentration: null, comparison: null };
        let cachedPrices = JSON.parse(localStorage.getItem('sv_cached_prices')) || { prices: {}, timestamp: null };
        let historicalDataCache = JSON.parse(localStorage.getItem('sv_historical_data')) || {};
        let popupTimeout = null;

        // Referencias de Activos SV (Optimizado para Baja Elasticidad)
        const stockRef = {
            // Tecnolog√≠a & AI
            "AVGO": { beta: 1.15, dgr: 18.5, yield: 1.4, sector: 'Tecnolog√≠a/AI', name: 'Broadcom Inc.' },
            "AAPL": { beta: 1.24, dgr: 7.5, yield: 0.5, sector: 'Tecnolog√≠a', name: 'Apple Inc.' },
            "MSFT": { beta: 0.89, dgr: 10.2, yield: 0.8, sector: 'Tecnolog√≠a', name: 'Microsoft Corp.' },
            "NVDA": { beta: 1.68, dgr: 15.2, yield: 0.03, sector: 'Tecnolog√≠a/AI', name: 'NVIDIA Corp.' },
            "GOOGL": { beta: 1.05, dgr: 0.0, yield: 0.0, sector: 'Tecnolog√≠a', name: 'Alphabet Inc.' },
            "META": { beta: 1.18, dgr: 0.0, yield: 0.0, sector: 'Tecnolog√≠a', name: 'Meta Platforms Inc.' },
            "TSLA": { beta: 2.01, dgr: 0.0, yield: 0.0, sector: 'Tecnolog√≠a/Auto', name: 'Tesla Inc.' },
            "AMD": { beta: 1.82, dgr: 0.0, yield: 0.0, sector: 'Tecnolog√≠a', name: 'Advanced Micro Devices' },
            "INTC": { beta: 0.68, dgr: 2.8, yield: 1.5, sector: 'Tecnolog√≠a', name: 'Intel Corp.' },
            "CSCO": { beta: 0.92, dgr: 3.2, yield: 3.0, sector: 'Tecnolog√≠a', name: 'Cisco Systems Inc.' },
            "ORCL": { beta: 0.88, dgr: 14.5, yield: 1.3, sector: 'Tecnolog√≠a', name: 'Oracle Corp.' },
            "IBM": { beta: 0.72, dgr: 1.2, yield: 4.8, sector: 'Tecnolog√≠a', name: 'IBM Corp.' },
            "CRM": { beta: 1.15, dgr: 0.0, yield: 0.0, sector: 'Tecnolog√≠a', name: 'Salesforce Inc.' },
            
            // Salud & Farmac√©uticas
            "JNJ": { beta: 0.54, dgr: 5.8, yield: 3.0, sector: 'Salud', name: 'Johnson & Johnson' },
            "ABBV": { beta: 0.58, dgr: 12.4, yield: 3.4, sector: 'Salud', name: 'AbbVie Inc.' },
            "PFE": { beta: 0.62, dgr: 5.5, yield: 5.8, sector: 'Salud', name: 'Pfizer Inc.' },
            "UNH": { beta: 0.75, dgr: 12.8, yield: 1.3, sector: 'Salud', name: 'UnitedHealth Group' },
            "MRK": { beta: 0.48, dgr: 7.2, yield: 2.8, sector: 'Salud', name: 'Merck & Co.' },
            "LLY": { beta: 0.52, dgr: 15.3, yield: 1.5, sector: 'Salud', name: 'Eli Lilly and Co.' },
            "BMY": { beta: 0.55, dgr: 2.5, yield: 4.5, sector: 'Salud', name: 'Bristol Myers Squibb' },
            "AMGN": { beta: 0.68, dgr: 10.2, yield: 3.2, sector: 'Salud', name: 'Amgen Inc.' },
            
            // Consumo & Retail
            "PEP": { beta: 0.52, dgr: 7.2, yield: 2.9, sector: 'Consumo', name: 'PepsiCo Inc.' },
            "KO": { beta: 0.59, dgr: 4.0, yield: 3.1, sector: 'Consumo', name: 'Coca-Cola Company' },
            "PG": { beta: 0.45, dgr: 5.5, yield: 2.5, sector: 'Consumo', name: 'Procter & Gamble' },
            "WMT": { beta: 0.51, dgr: 9.2, yield: 1.5, sector: 'Retail', name: 'Walmart Inc.' },
            "COST": { beta: 0.68, dgr: 13.5, yield: 0.6, sector: 'Retail', name: 'Costco Wholesale' },
            "MCD": { beta: 0.63, dgr: 7.8, yield: 2.2, sector: 'Consumo', name: 'McDonald\'s Corp.' },
            "NKE": { beta: 1.02, dgr: 11.5, yield: 1.4, sector: 'Consumo', name: 'Nike Inc.' },
            "SBUX": { beta: 0.82, dgr: 12.2, yield: 2.1, sector: 'Consumo', name: 'Starbucks Corp.' },
            
            // Finanzas & Bancos
            "MAIN": { beta: 1.05, dgr: 4.2, yield: 6.8, sector: 'Finanzas', name: 'Main Street Capital' },
            "JPM": { beta: 1.12, dgr: 8.5, yield: 2.4, sector: 'Finanzas', name: 'JPMorgan Chase & Co.' },
            "BAC": { beta: 1.25, dgr: 7.2, yield: 2.8, sector: 'Finanzas', name: 'Bank of America' },
            "WFC": { beta: 1.18, dgr: 6.5, yield: 2.6, sector: 'Finanzas', name: 'Wells Fargo & Co.' },
            "GS": { beta: 1.32, dgr: 9.8, yield: 2.3, sector: 'Finanzas', name: 'Goldman Sachs Group' },
            "MS": { beta: 1.28, dgr: 8.2, yield: 3.1, sector: 'Finanzas', name: 'Morgan Stanley' },
            "V": { beta: 0.95, dgr: 17.5, yield: 0.7, sector: 'Finanzas', name: 'Visa Inc.' },
            "MA": { beta: 1.02, dgr: 18.2, yield: 0.5, sector: 'Finanzas', name: 'Mastercard Inc.' },
            
            // Energ√≠a
            "XOM": { beta: 1.02, dgr: 3.8, yield: 3.6, sector: 'Energ√≠a', name: 'Exxon Mobil Corp.' },
            "CVX": { beta: 0.95, dgr: 6.2, yield: 3.4, sector: 'Energ√≠a', name: 'Chevron Corp.' },
            "COP": { beta: 1.15, dgr: 8.5, yield: 2.8, sector: 'Energ√≠a', name: 'ConocoPhillips' },
            "SLB": { beta: 1.42, dgr: 5.2, yield: 2.4, sector: 'Energ√≠a', name: 'Schlumberger Ltd.' },
            
            // Telecomunicaciones
            "VZ": { beta: 0.42, dgr: 2.1, yield: 6.5, sector: 'Telecomunicaciones', name: 'Verizon Communications' },
            "T": { beta: 0.68, dgr: -0.5, yield: 7.2, sector: 'Telecomunicaciones', name: 'AT&T Inc.' },
            "TMUS": { beta: 0.58, dgr: 0.0, yield: 1.8, sector: 'Telecomunicaciones', name: 'T-Mobile US Inc.' },
            
            // REIT & Inmobiliario
            "O": { beta: 0.82, dgr: 3.5, yield: 5.5, sector: 'REIT', name: 'Realty Income Corp.' },
            "SPG": { beta: 1.15, dgr: 2.8, yield: 5.2, sector: 'REIT', name: 'Simon Property Group' },
            "PSA": { beta: 0.68, dgr: 8.5, yield: 4.1, sector: 'REIT', name: 'Public Storage' },
            "AMT": { beta: 0.58, dgr: 9.2, yield: 3.2, sector: 'REIT', name: 'American Tower Corp.' },
            
            // Industrial & Manufactura
            "CAT": { beta: 1.18, dgr: 6.5, yield: 2.1, sector: 'Industrial', name: 'Caterpillar Inc.' },
            "BA": { beta: 1.35, dgr: 0.0, yield: 0.0, sector: 'Industrial', name: 'Boeing Company' },
            "GE": { beta: 1.08, dgr: 4.2, yield: 0.8, sector: 'Industrial', name: 'General Electric' },
            "MMM": { beta: 0.92, dgr: 1.5, yield: 5.8, sector: 'Industrial', name: '3M Company' },
            "HON": { beta: 1.05, dgr: 6.8, yield: 2.0, sector: 'Industrial', name: 'Honeywell International' },
            
            // Materiales & Qu√≠micos
            "LIN": { beta: 0.88, dgr: 8.5, yield: 1.4, sector: 'Materiales', name: 'Linde plc' },
            "APD": { beta: 0.82, dgr: 9.2, yield: 2.3, sector: 'Materiales', name: 'Air Products & Chemicals' },
            
            // Utilities
            "NEE": { beta: 0.48, dgr: 10.5, yield: 2.8, sector: 'Utilities', name: 'NextEra Energy Inc.' },
            "DUK": { beta: 0.35, dgr: 2.2, yield: 4.2, sector: 'Utilities', name: 'Duke Energy Corp.' },
            "SO": { beta: 0.38, dgr: 3.5, yield: 3.8, sector: 'Utilities', name: 'Southern Company' },
            
            // Criptomonedas (Beta estimado basado en volatilidad hist√≥rica)
            "BTC-USD": { beta: 2.5, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Bitcoin', isCrypto: true },
            "ETH-USD": { beta: 2.8, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Ethereum', isCrypto: true },
            "BNB-USD": { beta: 3.2, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Binance Coin', isCrypto: true },
            "ADA-USD": { beta: 3.5, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Cardano', isCrypto: true },
            "SOL-USD": { beta: 3.8, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Solana', isCrypto: true },
            "DOT-USD": { beta: 3.4, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Polkadot', isCrypto: true },
            "MATIC-USD": { beta: 3.6, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Polygon', isCrypto: true },
            "AVAX-USD": { beta: 3.7, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Avalanche', isCrypto: true },
            "LINK-USD": { beta: 3.3, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Chainlink', isCrypto: true },
            "UNI-USD": { beta: 3.5, dgr: 0.0, yield: 0.0, sector: 'Crypto', name: 'Uniswap', isCrypto: true }
        };

        window.onload = async () => {
            // Initialize multi-portfolio system
            portfolio = portfolios[currentPortfolioId]?.positions || [];
            loadPortfolioSelector();
            switchTab('main');
            
            // Initialize UI
            updateCacheStatus();
            populateTickerDropdown();
            renderDashboard();
            startTimer();
            
            // Cargar precios en background
            preloadStockPrices().then(() => {
                updateCacheStatus();
                populateTickerDropdown();
                if (portfolio.length > 0) updatePrices();
            });
        };

        function updateCacheStatus() {
            const statusEl = document.getElementById('cache-status');
            if (!statusEl) return;
            
            const priceCount = cachedPrices.prices ? Object.keys(cachedPrices.prices).length : 0;
            const totalSymbols = Object.keys(stockRef).length;
            const percentage = Math.round((priceCount / totalSymbols) * 100);
            
            if (priceCount === 0) {
                statusEl.textContent = 'Precios: Cargando...';
                statusEl.className = 'text-[9px] text-amber-500 font-mono animate-pulse';
            } else if (priceCount < totalSymbols) {
                statusEl.textContent = `Precios: ${priceCount}/${totalSymbols} (${percentage}%)`;
                statusEl.className = 'text-[9px] text-amber-400 font-mono';
            } else {
                statusEl.textContent = `Precios: ${priceCount}/${totalSymbols} ‚úì`;
                statusEl.className = 'text-[9px] text-emerald-500 font-mono';
            }
        }

        // --- PRECARGA DE PRECIOS CON MARKETSTACK ---
        async function preloadStockPrices() {
            const tickers = Object.keys(stockRef);
            const now = Date.now();
            const cacheExpiry = 15 * 60 * 1000; // 15 minutos para datos m√°s frescos
            
            // Verificar si el cache es v√°lido
            if (cachedPrices.timestamp && (now - cachedPrices.timestamp) < cacheExpiry) {
                console.log('Usando precios en cach√© (v√°lidos por 15 min)');
                return;
            }

            console.log('üöÄ Precargando precios con Marketstack API...');
            console.log(`Cargando ${tickers.length} s√≠mbolos en paralelo...`);
            
            // Preservar precios antiguos si existen
            const newCache = { 
                timestamp: now, 
                prices: cachedPrices.prices || {} 
            };
            
            // Marketstack permite m√∫ltiples s√≠mbolos en una llamada (hasta 100)
            const batchSize = 50; // Cargar 50 s√≠mbolos por request
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < tickers.length; i += batchSize) {
                const batch = tickers.slice(i, i + batchSize);
                const tickerString = batch.join(',');
                
                console.log(`üìä Lote ${Math.floor(i/batchSize) + 1}/${Math.ceil(tickers.length/batchSize)}: ${batch.length} s√≠mbolos`);
                
                try {
                    // Marketstack endpoint para datos en tiempo real (latest)
                    const res = await fetch(
                        `https://api.marketstack.com/v1/eod/latest?access_key=${MARKETSTACK_API_KEY}&symbols=${tickerString}&limit=1`
                    );
                    const data = await res.json();
                    
                    if (data.error) {
                        console.error(`‚ùå Error API Marketstack:`, data.error.message);
                        failCount += batch.length;
                        continue;
                    }
                    
                    if (data.data && Array.isArray(data.data)) {
                        data.data.forEach(quote => {
                            const ticker = quote.symbol;
                            const price = quote.close || quote.open; // Usar close o open si close no disponible
                            
                            if (price) {
                                newCache.prices[ticker] = parseFloat(price);
                                successCount++;
                                console.log(`‚úì ${ticker}: $${price.toFixed(2)}`);
                            } else {
                                failCount++;
                                console.warn(`‚ö†Ô∏è ${ticker}: Sin precio disponible`);
                            }
                        });
                    }
                    
                    // Guardar progreso despu√©s de cada lote
                    cachedPrices = newCache;
                    localStorage.setItem('sv_cached_prices', JSON.stringify(cachedPrices));
                    updateCacheStatus();
                    
                    // Peque√±a pausa entre lotes para evitar sobrecarga
                    if (i + batchSize < tickers.length) {
                        await new Promise(r => setTimeout(r, 1000)); // 1 segundo entre lotes
                    }
                    
                } catch (e) { 
                    console.error(`‚ùå Error cargando lote:`, e);
                    failCount += batch.length;
                }
            }
            
            console.log(`‚úÖ Precarga completada: ${successCount} √©xitos, ${failCount} fallos de ${tickers.length} totales`);
            
            // Si hubo muchos fallos, intentar fallback en cascada: Finnhub ‚Üí Alpha Vantage
            if (failCount > tickers.length * 0.3) {
                console.log('‚ö†Ô∏è Muchos fallos detectados. Iniciando fallback en cascada...');
                const missingAfterMarketstack = tickers.filter(t => !newCache.prices[t]);
                
                // 1. Intentar con Finnhub (m√°s r√°pido y con m√°s llamadas disponibles)
                const stillMissing = await fallbackToFinnhub(missingAfterMarketstack);
                
                // 2. Si a√∫n faltan, usar Alpha Vantage como √∫ltimo recurso
                if (stillMissing.length > 0) {
                    await fallbackToAlphaVantage(stillMissing);
                }
            }
        }
        
        // --- FALLBACK A FINNHUB (PRIORIDAD 1) ---
        async function fallbackToFinnhub(missingTickers) {
            if (missingTickers.length === 0) return missingTickers;
            
            console.log(`üîÑ Fallback Finnhub: Obteniendo ${missingTickers.length} s√≠mbolos con Finnhub...`);
            
            // Asegurar que cachedPrices.prices existe
            if (!cachedPrices.prices) {
                cachedPrices.prices = {};
            }
            
            const stillMissing = [];
            
            // Separar stocks de crypto (Finnhub usa diferentes endpoints)
            const cryptoSymbols = missingTickers.filter(t => t.includes('-USD'));
            const stockSymbols = missingTickers.filter(t => !t.includes('-USD'));
            
            // Finnhub permite 60 llamadas/minuto (free tier)
            const batchSize = 30;
            
            // Procesar stocks
            for (let i = 0; i < stockSymbols.length; i += batchSize) {
                const batch = stockSymbols.slice(i, i + batchSize);
                
                const results = await Promise.allSettled(
                    batch.map(async ticker => {
                        try {
                            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${FINNHUB_API_KEY}`);
                            const data = await res.json();
                            
                            if (data.c && data.c > 0) {
                                cachedPrices.prices[ticker] = parseFloat(data.c);
                                console.log(`‚úì Finnhub ${ticker}: $${data.c.toFixed(2)}`);
                                return { ticker, success: true };
                            } else {
                                return { ticker, success: false };
                            }
                        } catch (e) {
                            console.error(`‚ùå Finnhub error ${ticker}:`, e);
                            return { ticker, success: false };
                        }
                    })
                );
                
                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && !result.value.success) {
                        stillMissing.push(batch[idx]);
                    } else if (result.status === 'rejected') {
                        stillMissing.push(batch[idx]);
                    }
                });
                
                localStorage.setItem('sv_cached_prices', JSON.stringify(cachedPrices));
                updateCacheStatus();
                
                if (i + batchSize < stockSymbols.length) {
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
            
            // Procesar crypto con formato Finnhub: BINANCE:BTCUSDT
            for (let i = 0; i < cryptoSymbols.length; i += batchSize) {
                const batch = cryptoSymbols.slice(i, i + batchSize);
                
                const results = await Promise.allSettled(
                    batch.map(async ticker => {
                        try {
                            // Convertir BTC-USD a BINANCE:BTCUSDT para Finnhub
                            const cryptoBase = ticker.replace('-USD', '');
                            const finnhubSymbol = `BINANCE:${cryptoBase}USDT`;
                            
                            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${finnhubSymbol}&token=${FINNHUB_API_KEY}`);
                            const data = await res.json();
                            
                            if (data.c && data.c > 0) {
                                cachedPrices.prices[ticker] = parseFloat(data.c);
                                console.log(`‚úì Finnhub Crypto ${ticker}: $${data.c.toFixed(2)}`);
                                return { ticker, success: true };
                            } else {
                                return { ticker, success: false };
                            }
                        } catch (e) {
                            console.error(`‚ùå Finnhub crypto error ${ticker}:`, e);
                            return { ticker, success: false };
                        }
                    })
                );
                
                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled' && !result.value.success) {
                        stillMissing.push(batch[idx]);
                    } else if (result.status === 'rejected') {
                        stillMissing.push(batch[idx]);
                    }
                });
                
                localStorage.setItem('sv_cached_prices', JSON.stringify(cachedPrices));
                updateCacheStatus();
                
                if (i + batchSize < cryptoSymbols.length) {
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
            
            console.log(`‚úÖ Finnhub completado: ${missingTickers.length - stillMissing.length}/${missingTickers.length} exitosos`);
            return stillMissing;
        }
        
        // --- FALLBACK A ALPHA VANTAGE (PRIORIDAD 2) ---
        async function fallbackToAlphaVantage(missingTickers) {
            if (missingTickers.length === 0) return;
            
            console.log(`üîÑ Fallback Alpha Vantage: Obteniendo ${missingTickers.length} s√≠mbolos...`);
            
            // Asegurar que cachedPrices.prices existe
            if (!cachedPrices.prices) {
                cachedPrices.prices = {};
            }
            
            const batchSize = 5;
            
            for (let i = 0; i < Math.min(missingTickers.length, 10); i += batchSize) {
                const batch = missingTickers.slice(i, i + batchSize);
                
                for (let ticker of batch) {
                    try {
                        const res = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ticker}&apikey=${ALPHA_VANTAGE_KEY}`);
                        const data = await res.json();
                        
                        if (data["Global Quote"] && data["Global Quote"]["05. price"]) {
                            cachedPrices.prices[ticker] = parseFloat(data["Global Quote"]["05. price"]);
                            console.log(`‚úì Alpha Vantage ${ticker}: ${cachedPrices.prices[ticker].toFixed(2)}`);
                        }
                        
                        await new Promise(r => setTimeout(r, 12500)); // 12.5 seg entre llamadas
                    } catch (e) { 
                        console.error(`‚ùå Alpha Vantage error ${ticker}:`, e); 
                    }
                }
                
                localStorage.setItem('sv_cached_prices', JSON.stringify(cachedPrices));
                updateCacheStatus();
                
                if (i + batchSize < Math.min(missingTickers.length, 10)) {
                    await new Promise(r => setTimeout(r, 60000)); // 1 min entre lotes
                }
            }
        }

        // --- POBLAR DROPDOWN DE TICKERS ---
        function populateTickerDropdown() {
            const select = document.getElementById('sim-ticker');
            const tickers = Object.keys(stockRef).sort();
            
            tickers.forEach(ticker => {
                const option = document.createElement('option');
                option.value = ticker;
                const price = cachedPrices.prices && cachedPrices.prices[ticker] 
                    ? ` - ${cachedPrices.prices[ticker].toFixed(2)}` 
                    : '';
                option.textContent = `${ticker} - ${stockRef[ticker].name}${price}`;
                select.appendChild(option);
            });

            // Listener para mostrar precio actual
            select.addEventListener('change', function() {
                const ticker = this.value;
                const priceInfo = document.getElementById('ticker-price-info');
                const priceDisplay = document.getElementById('ticker-current-price');
                
                if (ticker && cachedPrices.prices && cachedPrices.prices[ticker]) {
                    priceDisplay.textContent = `Precio actual: ${cachedPrices.prices[ticker].toFixed(2)} | Beta: ${stockRef[ticker].beta} | Yield: ${stockRef[ticker].yield}%`;
                    priceInfo.classList.remove('hidden');
                    
                    // Auto-rellenar el costo promedio con el precio actual
                    document.getElementById('sim-cost').value = cachedPrices.prices[ticker].toFixed(2);
                } else {
                    priceInfo.classList.add('hidden');
                }
            });
        }

        // --- MOTOR DE PROYECCI√ìN SEMANAL & PRECIOS ---
        async function updatePrices() {
            const indicator = document.getElementById('live-indicator');
            indicator.className = "w-2 h-2 rounded-full bg-amber-500 animate-pulse";
            
            // Obtener todos los tickers del portafolio
            const portfolioTickers = portfolio.map(item => item.ticker);
            
            if (portfolioTickers.length === 0) {
                indicator.className = "w-2 h-2 rounded-full bg-slate-300";
                return;
            }
            
            try {
                // Intentar obtener precios con Marketstack (m√°s r√°pido, batch request)
                const tickerString = portfolioTickers.join(',');
                const res = await fetch(
                    `https://api.marketstack.com/v1/eod/latest?access_key=${MARKETSTACK_API_KEY}&symbols=${tickerString}&limit=1`
                );
                const data = await res.json();
                
                if (data.data && Array.isArray(data.data)) {
                    // Actualizar precios del portafolio
                    data.data.forEach(quote => {
                        const portfolioItem = portfolio.find(item => item.ticker === quote.symbol);
                        if (portfolioItem) {
                            portfolioItem.currentPrice = parseFloat(quote.close || quote.open);
                            // Actualizar cach√© tambi√©n
                            if (!cachedPrices.prices) cachedPrices.prices = {};
                            cachedPrices.prices[quote.symbol] = portfolioItem.currentPrice;
                        }
                    });
                    
                    // Guardar cach√© actualizado
                    cachedPrices.timestamp = Date.now();
                    localStorage.setItem('sv_cached_prices', JSON.stringify(cachedPrices));
                    
                    console.log(`‚úÖ Precios actualizados v√≠a Marketstack: ${data.data.length}/${portfolioTickers.length}`);
                } else {
                    console.warn('‚ö†Ô∏è Marketstack no devolvi√≥ datos, usando cach√©');
                    // Usar precios en cach√©
                    portfolio.forEach(item => {
                        if (cachedPrices.prices && cachedPrices.prices[item.ticker]) {
                            item.currentPrice = cachedPrices.prices[item.ticker];
                        }
                    });
                }
            } catch (e) {
                console.error('‚ùå Error actualizando precios con Marketstack:', e);
                // Fallback: usar precios en cach√©
                portfolio.forEach(item => {
                    if (cachedPrices.prices && cachedPrices.prices[item.ticker]) {
                        item.currentPrice = cachedPrices.prices[item.ticker];
                    }
                });
            }
            
            indicator.className = "w-2 h-2 rounded-full bg-emerald-500";
            saveAndRefresh();
        }

        function renderDashboard() {
            const body = document.getElementById('portfolio-body');
            body.innerHTML = '';
            let stats = { val: 0, cost: 0, beta: 0, yield: 0, dgr: 0 };

            portfolio.forEach(item => {
                const marketVal = item.shares * item.currentPrice;
                const costBasis = item.shares * item.avgCost;
                const pl = ((item.currentPrice - item.avgCost) / item.avgCost * 100).toFixed(2);
                
                stats.val += marketVal;
                stats.cost += costBasis;
                stats.beta += (item.beta * marketVal);
                stats.yield += (item.dividendYield * marketVal);
                stats.dgr += (item.dgr * marketVal);

                body.innerHTML += `
                    <tr class="group hover:bg-slate-50 transition-all border-l-4 border-transparent hover:border-indigo-500">
                        <td class="p-4 ticker-hover" onmouseenter="showChartPopup(event, '${item.ticker}')" onmouseleave="hideChartPopup()">
                            <div class="flex flex-col">
                                <span class="font-black text-slate-800 text-sm">${item.ticker}</span>
                                <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">${item.sector || 'S/D'}</span>
                            </div>
                        </td>
                        <td class="p-4 text-right font-bold text-sm text-slate-600">${item.shares.toFixed(2)}</td>
                        <td class="p-4 text-right font-bold text-sm text-slate-800">${item.currentPrice.toFixed(2)}</td>
                        <td class="p-4 text-right font-black text-sm text-slate-900">${marketVal.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        <td class="p-4 text-center">
                            <span class="inline-block px-3 py-1 rounded-full font-black text-xs ${pl >= 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}">
                                ${pl >= 0 ? '+' : ''}${pl}%
                            </span>
                        </td>
                        <td class="p-4 text-center">
                            <span class="inline-block px-2 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold">${item.beta}</span>
                        </td>
                        <td class="p-4">
                            <div class="flex gap-2 justify-center">
                                <button onclick="analyzeTicker('${item.ticker}')" class="px-3 py-2 bg-indigo-50 text-indigo-600 rounded-xl text-[10px] font-black uppercase hover:bg-indigo-600 hover:text-white transition-all shadow-sm hover:shadow-md" title="An√°lisis AI">
                                    <i class="fa-solid fa-brain mr-1"></i>AI
                                </button>
                                <button onclick="removePosition(${item.id})" class="px-3 py-2 bg-rose-50 text-rose-600 rounded-xl text-[10px] font-black hover:bg-rose-600 hover:text-white transition-all shadow-sm hover:shadow-md" title="Eliminar posici√≥n">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            updateHeaderStats(stats);
            updateCharts(stats);
        }

        function updateHeaderStats(stats) {
            const total = stats.val;
            const avgY = total > 0 ? (stats.yield / total) : 0;
            const avgB = total > 0 ? (stats.beta / total) : 0;
            const avgD = total > 0 ? (stats.dgr / total) : 0;
            
            // Meta Semanal: r = (1.20)^(1/52)-1 ‚âà 0.35%
            const weeklyTargetVal = total * 0.0035;

            document.getElementById('total-value').innerText = `$${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('weekly-target').innerText = `+$${weeklyTargetVal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('portfolio-beta').innerText = avgB.toFixed(2);
            
            // Proyecci√≥n Anual Estimada
            const proj = avgY + (avgD * 0.6) + 7;
            document.getElementById('projection-return').innerText = `${proj.toFixed(1)}%`;

            // Beta UI status
            const status = document.getElementById('beta-status');
            status.innerText = avgB < 0.85 ? "Elasticidad √ìptima" : "Exposici√≥n Moderada";
            status.className = `text-[10px] font-black mt-1 uppercase ${avgB < 0.85 ? 'text-emerald-500' : 'text-amber-500'}`;
        }

        // --- OBTENER NOTICIAS DEL MERCADO ---
        async function fetchMarketNews(ticker) {
            // 1. PRIORIDAD: Finnhub Company News (free tier: 60 llamadas/minuto)
            try {
                const toDate = new Date().toISOString().split('T')[0];
                const fromDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const res = await fetch(
                    `https://finnhub.io/api/v1/company-news?symbol=${ticker}&from=${fromDate}&to=${toDate}&token=${FINNHUB_API_KEY}`
                );
                const data = await res.json();
                
                if (data && Array.isArray(data) && data.length > 0) {
                    console.log(`‚úì Noticias Finnhub ${ticker}: ${data.length} art√≠culos`);
                    return data.slice(0, 5).map(article => ({
                        title: article.headline,
                        description: article.summary,
                        sentiment: article.sentiment || 0, // Finnhub no provee sentiment directamente, lo calculamos con otro endpoint
                        published: new Date(article.datetime * 1000).toISOString(),
                        source: article.source,
                        url: article.url
                    }));
                }
            } catch (e) {
                console.warn('No se pudieron obtener noticias de Finnhub:', e);
            }
            
            // 2. FALLBACK: Marketaux si est√° configurado
            if (MARKETAUX_API_KEY && MARKETAUX_API_KEY !== "") {
                try {
                    const res = await fetch(
                        `https://api.marketaux.com/v1/news/all?symbols=${ticker}&filter_entities=true&language=en&api_token=${MARKETAUX_API_KEY}&limit=3`
                    );
                    const data = await res.json();
                    
                    if (data.data && data.data.length > 0) {
                        return data.data.map(article => ({
                            title: article.title,
                            description: article.description || article.snippet,
                            sentiment: article.entities?.find(e => e.symbol === ticker)?.sentiment_score || 0,
                            published: article.published_at
                        }));
                    }
                } catch (e) {
                    console.warn('No se pudieron obtener noticias de Marketaux:', e);
                }
            }
            
            // 3. √öLTIMO FALLBACK: Alpha Vantage News Sentiment (gratis pero limitado)
            try {
                const res = await fetch(
                    `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=${ticker}&apikey=${ALPHA_VANTAGE_KEY}&limit=3`
                );
                const data = await res.json();
                
                if (data.feed && data.feed.length > 0) {
                    return data.feed.map(article => ({
                        title: article.title,
                        description: article.summary,
                        sentiment: parseFloat(article.ticker_sentiment?.find(t => t.ticker === ticker)?.ticker_sentiment_score || 0),
                        published: article.time_published
                    }));
                }
            } catch (e) {
                console.warn('No se pudieron obtener noticias de Alpha Vantage:', e);
            }
            
            return [];
        }
        
        // --- FINNHUB: OBTENER DATOS FUNDAMENTALES ---
        async function fetchFinnhubFundamentals(ticker) {
            try {
                const res = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${ticker}&token=${FINNHUB_API_KEY}`);
                const data = await res.json();
                
                if (data && data.ticker) {
                    return {
                        name: data.name,
                        sector: data.finnhubIndustry || data.ggroup,
                        marketCap: data.marketCapitalization,
                        country: data.country,
                        exchange: data.exchange,
                        ipo: data.ipo,
                        weburl: data.weburl,
                        logo: data.logo,
                        phone: data.phone
                    };
                }
            } catch (e) {
                console.warn(`No se pudieron obtener fundamentales de Finnhub para ${ticker}:`, e);
            }
            return null;
        }
        
        // --- FINNHUB: SENTIMENT ANALYSIS (NEWS + SOCIAL) ---
        async function fetchFinnhubSentiment(ticker) {
            try {
                // Obtener sentiment de noticias (√∫ltimo mes)
                const res = await fetch(`https://finnhub.io/api/v1/news-sentiment?symbol=${ticker}&token=${FINNHUB_API_KEY}`);
                const data = await res.json();
                
                if (data && data.sentiment) {
                    return {
                        buzz: data.buzz?.articlesInLastWeek || 0,
                        weeklyAverage: data.buzz?.weeklyAverage || 0,
                        sentiment: data.sentiment?.bearishPercent !== undefined ? 
                            (data.sentiment.bullishPercent - data.sentiment.bearishPercent) / 100 : 0,
                        bullishPercent: data.sentiment?.bullishPercent || 0,
                        bearishPercent: data.sentiment?.bearishPercent || 0,
                        companyNewsScore: data.companyNewsScore || 0,
                        sectorAverageBullishPercent: data.sectorAverageBullishPercent || 0,
                        sectorAverageNewsScore: data.sectorAverageNewsScore || 0
                    };
                }
            } catch (e) {
                console.warn(`No se pudo obtener sentiment de Finnhub para ${ticker}:`, e);
            }
            return null;
        }

        // --- BLACKBOX AI AGENT INTEGRATION CON AN√ÅLISIS MEJORADO ---
        async function analyzeTicker(ticker) {
            if (!BLACKBOX_API_KEY || BLACKBOX_API_KEY === "$BLACKBOX_API_KEY") {
                openAIModal(ticker, '<p class="text-rose-400 text-sm font-bold">‚ö†Ô∏è API KEY DE BLACKBOX NO CONFIGURADA.</p><p class="text-slate-400 text-xs mt-2">Por favor, configura tu API key en la variable BLACKBOX_API_KEY.</p>');
                return;
            }

            // Abrir modal y mostrar loader
            openAIModal(ticker, null, true);

            try {
                // Obtener datos en paralelo para mayor velocidad
                const [historicalData, newsData, fundamentals, sentiment] = await Promise.all([
                    fetchHistoricalData(ticker),
                    fetchMarketNews(ticker),
                    fetchFinnhubFundamentals(ticker),
                    fetchFinnhubSentiment(ticker)
                ]);
                
                // Preparar contexto enriquecido para la IA
                let contextPrompt = `Analiza el ticker ${ticker} (${stockRef[ticker]?.name || fundamentals?.name || 'Desconocido'}) para los pr√≥ximos 7 d√≠as.\n\n`;
                
                // Agregar datos t√©cnicos (combinar local + Finnhub)
                contextPrompt += `DATOS T√âCNICOS:\n`;
                contextPrompt += `- Beta: ${stockRef[ticker]?.beta || 'N/A'} (Elasticidad del mercado)\n`;
                contextPrompt += `- Dividend Yield: ${stockRef[ticker]?.yield || 0}%\n`;
                contextPrompt += `- DGR (Crecimiento dividendos): ${stockRef[ticker]?.dgr || 0}%\n`;
                contextPrompt += `- Sector: ${fundamentals?.sector || stockRef[ticker]?.sector || 'N/A'}\n`;
                
                if (fundamentals) {
                    contextPrompt += `- Market Cap: $${fundamentals.marketCap ? (fundamentals.marketCap / 1000).toFixed(2) + 'B' : 'N/A'}\n`;
                    contextPrompt += `- Pa√≠s: ${fundamentals.country || 'N/A'}\n`;
                    contextPrompt += `- Exchange: ${fundamentals.exchange || 'N/A'}\n`;
                }
                contextPrompt += `\n`;
                
                // Agregar sentiment de Finnhub si est√° disponible
                if (sentiment) {
                    contextPrompt += `SENTIMENT DEL MERCADO (Finnhub):\n`;
                    contextPrompt += `- Buzz (art√≠culos esta semana): ${sentiment.buzz}\n`;
                    contextPrompt += `- Sentiment general: ${sentiment.sentiment > 0 ? 'üìà Alcista' : sentiment.sentiment < 0 ? 'üìâ Bajista' : '‚û°Ô∏è Neutral'} (${(sentiment.sentiment * 100).toFixed(1)}%)\n`;
                    contextPrompt += `- Porcentaje alcista: ${sentiment.bullishPercent.toFixed(1)}%\n`;
                    contextPrompt += `- Porcentaje bajista: ${sentiment.bearishPercent.toFixed(1)}%\n`;
                    contextPrompt += `- Score de noticias: ${sentiment.companyNewsScore.toFixed(2)}\n`;
                    contextPrompt += `- Promedio del sector: ${sentiment.sectorAverageBullishPercent.toFixed(1)}% alcista\n\n`;
                }
                
                // Agregar datos hist√≥ricos si est√°n disponibles
                if (historicalData && historicalData.prices) {
                    contextPrompt += `RENDIMIENTO √öLTIMOS 7 D√çAS:\n`;
                    contextPrompt += `- Cambio: ${historicalData.change}%\n`;
                    contextPrompt += `- M√°ximo: $${historicalData.high.toFixed(2)}\n`;
                    contextPrompt += `- M√≠nimo: $${historicalData.low.toFixed(2)}\n`;
                    contextPrompt += `- Precio actual: $${historicalData.prices[historicalData.prices.length - 1].toFixed(2)}\n`;
                    contextPrompt += `- Volatilidad: ${((historicalData.high - historicalData.low) / historicalData.low * 100).toFixed(2)}%\n\n`;
                }
                
                // Agregar noticias y sentimiento si est√°n disponibles
                if (newsData.length > 0) {
                    contextPrompt += `NOTICIAS RECIENTES Y SENTIMIENTO:\n`;
                    newsData.forEach((news, idx) => {
                        const sentimentLabel = news.sentiment > 0.15 ? 'üìà Positivo' : 
                                              news.sentiment < -0.15 ? 'üìâ Negativo' : '‚û°Ô∏è Neutral';
                        contextPrompt += `${idx + 1}. ${news.title}\n   Sentimiento: ${sentimentLabel} (${news.sentiment.toFixed(2)})\n`;
                    });
                    contextPrompt += `\n`;
                }
                
                // Agregar objetivo del an√°lisis
                contextPrompt += `OBJETIVO:\n`;
                contextPrompt += `Eval√∫a si este activo ayudar√° a mantener la proyecci√≥n semanal de 0.35% de retorno.\n`;
                contextPrompt += `Considera la elasticidad (Beta), el momentum hist√≥rico, el sentimiento del mercado y factores de riesgo.\n\n`;
                contextPrompt += `Responde en espa√±ol con:\n`;
                contextPrompt += `1. An√°lisis t√©cnico (precio y volatilidad)\n`;
                contextPrompt += `2. An√°lisis fundamental (Beta, sector, noticias)\n`;
                contextPrompt += `3. Recomendaci√≥n espec√≠fica (COMPRAR/MANTENER/VENDER) con razones\n`;
                
                const API_URL = "https://api.blackbox.ai/chat/completions";
                
                const requestData = {
                    "model": "blackboxai/openai/gpt-4",
                    "messages": [
                        {
                            "role": "user",
                            "content": contextPrompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 800,
                    "stream": false
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${BLACKBOX_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const responseData = await response.json();
                console.log('Respuesta IA:', responseData);
                
                if (responseData.choices && responseData.choices[0] && responseData.choices[0].message) {
                    const aiResponse = responseData.choices[0].message.content;
                    
                    // Formatear respuesta con secciones y datos hist√≥ricos
                    let formattedResponse = `<div class="space-y-4 text-sm leading-relaxed">`;
                    
                    // Agregar contexto hist√≥rico si est√° disponible
                    if (historicalData && historicalData.prices) {
                        const changeClass = parseFloat(historicalData.change) >= 0 ? 'text-emerald-400' : 'text-rose-400';
                        const changeIcon = parseFloat(historicalData.change) >= 0 ? 'üìà' : 'üìâ';
                        
                        formattedResponse += `
                            <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <h4 class="text-xs font-black uppercase text-slate-400 mb-2">üìä Datos Hist√≥ricos (7 d√≠as)</h4>
                                <div class="grid grid-cols-2 gap-3 text-xs">
                                    <div>
                                        <span class="text-slate-500">Cambio:</span>
                                        <span class="font-bold ${changeClass}"> ${changeIcon} ${historicalData.change}%</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-500">Volatilidad:</span>
                                        <span class="font-bold text-amber-400"> ${((historicalData.high - historicalData.low) / historicalData.low * 100).toFixed(2)}%</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-500">M√°ximo:</span>
                                        <span class="font-bold text-indigo-400"> $${historicalData.high.toFixed(2)}</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-500">M√≠nimo:</span>
                                        <span class="font-bold text-purple-400"> $${historicalData.low.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Agregar noticias si est√°n disponibles
                    if (newsData && newsData.length > 0) {
                        formattedResponse += `
                            <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <h4 class="text-xs font-black uppercase text-slate-400 mb-3">üì∞ Noticias Recientes</h4>
                                <div class="space-y-2">
                        `;
                        
                        newsData.forEach(news => {
                            const sentimentEmoji = news.sentiment > 0.15 ? 'üòä' : news.sentiment < -0.15 ? 'üòü' : 'üòê';
                            const sentimentColor = news.sentiment > 0.15 ? 'text-emerald-400' : news.sentiment < -0.15 ? 'text-rose-400' : 'text-slate-400';
                            
                            formattedResponse += `
                                <div class="text-xs border-l-2 border-indigo-500 pl-3 py-1">
                                    <p class="font-bold text-slate-200">${news.title}</p>
                                    <p class="${sentimentColor} text-[10px] mt-1">
                                        ${sentimentEmoji} Sentimiento: ${news.sentiment > 0 ? '+' : ''}${news.sentiment.toFixed(2)}
                                    </p>
                                </div>
                            `;
                        });
                        
                        formattedResponse += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // Agregar an√°lisis de IA
                    formattedResponse += `
                        <div class="bg-gradient-to-br from-indigo-900/30 to-purple-900/30 rounded-xl p-4 border border-indigo-500/30">
                            <h4 class="text-xs font-black uppercase text-indigo-300 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-brain"></i> An√°lisis Inteligente
                            </h4>
                            <div class="text-sm leading-relaxed">
                                ${aiResponse.replace(/\n/g, '<br><br>')}
                            </div>
                        </div>
                    `;
                    
                    formattedResponse += `</div>`;
                    
                    openAIModal(ticker, formattedResponse);
                } else {
                    throw new Error('Respuesta inv√°lida de la API');
                }
            } catch (err) {
                console.error('Error en analyzeTicker:', err);
                openAIModal(ticker, `<p class="text-rose-400 text-sm font-bold">‚ùå Error al conectar con BlackboxAI</p><p class="text-slate-400 text-xs mt-2">Revisa la conexi√≥n o el saldo de la API.</p><pre class="text-xs text-slate-500 mt-3 bg-slate-900/50 p-3 rounded-lg overflow-auto">${err.message}</pre>`);
            }
        }

        function openAIModal(ticker, content, showLoader = false) {
            const modal = document.getElementById('ai-modal');
            const modalTicker = document.getElementById('ai-modal-ticker');
            const modalContent = document.getElementById('ai-modal-content');
            const modalLoader = document.getElementById('ai-modal-loader');

            // Manejo especial para an√°lisis global
            if (ticker === 'PORTAFOLIO GLOBAL') {
                modalTicker.textContent = 'üéØ Portafolio Completo - An√°lisis Global';
            } else {
                modalTicker.textContent = `${ticker} - ${stockRef[ticker]?.name || 'An√°lisis de Mercado'}`;
            }
            
            if (showLoader) {
                modalLoader.classList.remove('hidden');
                modalContent.innerHTML = '';
            } else {
                modalLoader.classList.add('hidden');
                modalContent.innerHTML = content;
            }

            modal.classList.remove('hidden');
        }

        function closeAIModal() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        // --- AI PORTFOLIO BUILDER ---
        let recommendedPortfolio = [];

        function openAIPortfolioBuilder() {
            const modal = document.getElementById('ai-portfolio-modal');
            document.getElementById('ai-portfolio-form').classList.remove('hidden');
            document.getElementById('ai-portfolio-loader').classList.add('hidden');
            document.getElementById('ai-portfolio-result').classList.add('hidden');
            modal.classList.remove('hidden');
        }

        function closeAIPortfolioModal() {
            document.getElementById('ai-portfolio-modal').classList.add('hidden');
            recommendedPortfolio = [];
        }

        async function generateAIPortfolio() {
            if (!BLACKBOX_API_KEY || BLACKBOX_API_KEY === "$BLACKBOX_API_KEY") {
                alert('‚ö†Ô∏è API KEY DE BLACKBOX NO CONFIGURADA.\n\nPor favor, configura tu API key en la variable BLACKBOX_API_KEY.');
                return;
            }

            const capital = parseFloat(document.getElementById('portfolio-capital').value);
            const risk = document.getElementById('portfolio-risk').value;
            const goal = document.getElementById('portfolio-goal').value;

            if (!capital || capital <= 0) {
                alert('Por favor ingresa un capital v√°lido.');
                return;
            }

            // Mostrar loader
            document.getElementById('ai-portfolio-form').classList.add('hidden');
            document.getElementById('ai-portfolio-loader').classList.remove('hidden');

            try {
                // Preparar contexto de s√≠mbolos disponibles
                const availableSymbols = Object.keys(stockRef).map(ticker => {
                    const stock = stockRef[ticker];
                    return `${ticker} (${stock.name}): Beta=${stock.beta}, Yield=${stock.yield}%, DGR=${stock.dgr}%, Sector=${stock.sector}`;
                }).join('\n');

                const riskDesc = {
                    'conservative': 'conservador con Beta menor a 0.7, priorizando estabilidad y dividendos altos',
                    'moderate': 'moderado con Beta entre 0.7 y 1.2, balanceando crecimiento y estabilidad',
                    'aggressive': 'agresivo con Beta mayor a 1.2, priorizando alto crecimiento'
                };

                const goalDesc = {
                    'dividend': 'maximizar ingresos por dividendos (Yield alto)',
                    'growth': 'maximizar crecimiento de capital (DGR alto)',
                    'balanced': 'balancear dividendos y crecimiento'
                };

                const prompt = `Eres un asesor financiero experto. Crea un portafolio de inversi√≥n optimizado con las siguientes caracter√≠sticas:

Capital: ${capital.toLocaleString()}
Perfil de Riesgo: ${riskDesc[risk]}
Objetivo: ${goalDesc[goal]}

S√≠mbolos disponibles:
${availableSymbols}

INSTRUCCIONES:
1. Selecciona entre 5-8 s√≠mbolos que mejor se ajusten al perfil
2. Diversifica por sectores (m√°ximo 30% en un sector)
3. Calcula la cantidad de acciones para cada s√≠mbolo bas√°ndote en el capital disponible
4. Asegura que el Beta promedio del portafolio se alinee con el perfil de riesgo
5. Proyecta el rendimiento esperado a 7 d√≠as y 12 meses

FORMATO DE RESPUESTA (ESTRICTO):
Responde SOLO con un JSON v√°lido en este formato exacto:
{
  "analysis": "Breve an√°lisis de la estrategia (2-3 l√≠neas)",
  "portfolio": [
    {"ticker": "AAPL", "shares": 10, "reason": "Raz√≥n breve"},
    {"ticker": "JNJ", "shares": 15, "reason": "Raz√≥n breve"}
  ],
  "metrics": {
    "avgBeta": 0.85,
    "avgYield": 2.5,
    "weeklyProjection": 0.4,
    "yearlyProjection": 18.5
  }
}

NO incluyas texto adicional, SOLO el JSON.`;

                const API_URL = "https://api.blackbox.ai/chat/completions";
                const requestData = {
                    "model": "blackboxai/openai/gpt-4",
                    "messages": [
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.8,
                    "max_tokens": 1024,
                    "stream": false
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${BLACKBOX_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const responseData = await response.json();
                console.log('AI Response:', responseData);

                if (responseData.choices && responseData.choices[0] && responseData.choices[0].message) {
                    const aiContent = responseData.choices[0].message.content;
                    
                    // Extraer JSON de la respuesta
                    let jsonMatch = aiContent.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('No se pudo extraer JSON de la respuesta');
                    }

                    const portfolioData = JSON.parse(jsonMatch[0]);
                    displayAIPortfolio(portfolioData, capital);
                } else {
                    throw new Error('Respuesta inv√°lida de la API');
                }
            } catch (err) {
                console.error('Error en generateAIPortfolio:', err);
                document.getElementById('ai-portfolio-loader').classList.add('hidden');
                document.getElementById('ai-portfolio-form').classList.remove('hidden');
                alert(`‚ùå Error al generar portafolio:\n${err.message}\n\nIntenta nuevamente.`);
            }
        }

        function displayAIPortfolio(data, capital) {
            recommendedPortfolio = data.portfolio;

            // Mostrar an√°lisis
            const contentDiv = document.getElementById('ai-portfolio-content');
            contentDiv.innerHTML = `
                <p class="text-slate-300 mb-4">${data.analysis}</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 bg-slate-900/50 p-4 rounded-xl">
                    <div>
                        <p class="text-xs text-slate-500 uppercase font-black">Beta Promedio</p>
                        <p class="text-lg font-black text-purple-400">${data.metrics.avgBeta.toFixed(2)}</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500 uppercase font-black">Yield Promedio</p>
                        <p class="text-lg font-black text-emerald-400">${data.metrics.avgYield.toFixed(2)}%</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500 uppercase font-black">Proyecci√≥n 7D</p>
                        <p class="text-lg font-black text-indigo-400">+${data.metrics.weeklyProjection.toFixed(2)}%</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500 uppercase font-black">Proyecci√≥n 12M</p>
                        <p class="text-lg font-black text-amber-400">+${data.metrics.yearlyProjection.toFixed(1)}%</p>
                    </div>
                </div>
            `;

            // Mostrar s√≠mbolos
            const symbolsDiv = document.getElementById('ai-portfolio-symbols');
            symbolsDiv.innerHTML = data.portfolio.map(item => {
                const stock = stockRef[item.ticker];
                const estimatedCost = (cachedPrices.prices && cachedPrices.prices[item.ticker]) 
                    ? cachedPrices.prices[item.ticker] * item.shares 
                    : 0;
                
                return `
                    <div class="bg-slate-900/50 p-3 rounded-xl border border-purple-500/20 hover:border-purple-500/50 transition-all">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-black text-white text-sm">${item.ticker}</span>
                            <span class="text-xs font-bold text-slate-400">${item.shares}x</span>
                        </div>
                        <p class="text-[10px] text-slate-500 mb-1">${stock?.name || 'N/A'}</p>
                        <p class="text-xs text-purple-300 font-bold">~${estimatedCost.toFixed(0)}</p>
                        <p class="text-[9px] text-slate-400 mt-1 italic">${item.reason}</p>
                    </div>
                `;
            }).join('');

            // Mostrar resultado
            document.getElementById('ai-portfolio-loader').classList.add('hidden');
            document.getElementById('ai-portfolio-result').classList.remove('hidden');
        }

        async function applyAIPortfolio() {
            if (recommendedPortfolio.length === 0) {
                alert('No hay portafolio para aplicar.');
                return;
            }

            if (!confirm(`¬øDeseas agregar ${recommendedPortfolio.length} posiciones al portafolio?\n\nEsto agregar√° las posiciones recomendadas por la IA.`)) {
                return;
            }

            // Verificar cu√°ntos s√≠mbolos tienen precios reales
            const tickersWithoutPrice = recommendedPortfolio.filter(item => 
                !cachedPrices.prices || !cachedPrices.prices[item.ticker]
            );

            if (tickersWithoutPrice.length > 0) {
                const shouldFetch = confirm(
                    `‚ö†Ô∏è ${tickersWithoutPrice.length} s√≠mbolos no tienen precio en cach√©:\n${tickersWithoutPrice.map(i => i.ticker).join(', ')}\n\n` +
                    `¬øDeseas obtener precios actuales? (Tomar√° ~${tickersWithoutPrice.length * 13} segundos)\n\n` +
                    `Si cancelas, se usar√°n precios estimados.`
                );

                if (shouldFetch) {
                    // Obtener precios faltantes
                    for (let item of tickersWithoutPrice) {
                        try {
                            console.log(`Obteniendo precio de ${item.ticker}...`);
                            const res = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${item.ticker}&apikey=${ALPHA_VANTAGE_KEY}`);
                            const data = await res.json();
                            
                            if (data["Global Quote"] && data["Global Quote"]["05. price"]) {
                                if (!cachedPrices.prices) cachedPrices.prices = {};
                                cachedPrices.prices[item.ticker] = parseFloat(data["Global Quote"]["05. price"]);
                                console.log(`‚úì ${item.ticker}: ${cachedPrices.prices[item.ticker].toFixed(2)}`);
                            }
                            
                            await new Promise(r => setTimeout(r, 13000)); // 13 segundos entre llamadas
                        } catch (e) {
                            console.error(`Error obteniendo precio de ${item.ticker}:`, e);
                        }
                    }
                    
                    // Actualizar cach√©
                    cachedPrices.timestamp = Date.now();
                    localStorage.setItem('sv_cached_prices', JSON.stringify(cachedPrices));
                }
            }

            recommendedPortfolio.forEach(item => {
                const ticker = item.ticker;
                const shares = item.shares;
                const ref = stockRef[ticker];
                
                if (!ref) return;

                // Usar precio en cach√© o estimado
                const currentPrice = (cachedPrices.prices && cachedPrices.prices[ticker]) 
                    ? cachedPrices.prices[ticker] 
                    : 100; // Precio estimado si no hay cach√©

                portfolio.push({
                    id: Date.now() + Math.random(),
                    ticker,
                    shares,
                    avgCost: currentPrice,
                    currentPrice: currentPrice,
                    beta: ref.beta,
                    dgr: ref.dgr,
                    dividendYield: ref.yield,
                    sector: ref.sector
                });
            });

            saveAndRefresh();
            closeAIPortfolioModal();
            
            const realPrices = recommendedPortfolio.filter(item => 
                cachedPrices.prices && cachedPrices.prices[item.ticker]
            ).length;
            
            alert(`‚úÖ Portafolio AI aplicado exitosamente!\n\n${recommendedPortfolio.length} posiciones agregadas.\n${realPrices} con precios reales, ${recommendedPortfolio.length - realPrices} con precios estimados.`);
        }

        async function getGlobalForecast() {
            if (portfolio.length === 0) {
                alert('‚ö†Ô∏è No hay activos en el portafolio para analizar.');
                return;
            }
            
            if (!BLACKBOX_API_KEY || BLACKBOX_API_KEY === "$BLACKBOX_API_KEY") {
                alert('‚ö†Ô∏è API KEY DE BLACKBOX NO CONFIGURADA.');
                return;
            }
            
            // Abrir modal con identificador especial para an√°lisis global
            openAIModal('PORTAFOLIO GLOBAL', null, true);
            
            try {
                // Preparar datos del portafolio
                const tickers = portfolio.map(p => p.ticker).join(", ");
                let totalValue = 0;
                let weightedBeta = 0;
                let weightedYield = 0;
                let sectorAllocation = {};
                
                portfolio.forEach(item => {
                    const value = item.shares * item.currentPrice;
                    totalValue += value;
                    weightedBeta += item.beta * value;
                    weightedYield += item.dividendYield * value;
                    
                    const sector = item.sector || 'Otro';
                    sectorAllocation[sector] = (sectorAllocation[sector] || 0) + value;
                });
                
                const avgBeta = totalValue > 0 ? weightedBeta / totalValue : 0;
                const avgYield = totalValue > 0 ? weightedYield / totalValue : 0;
                
                // Formatear asignaci√≥n sectorial
                const sectorBreakdown = Object.entries(sectorAllocation)
                    .map(([sector, value]) => `  - ${sector}: ${((value/totalValue)*100).toFixed(1)}%`)
                    .join('\n');
                
                // Obtener noticias de los principales activos (top 3 por peso)
                const topHoldings = [...portfolio]
                    .sort((a, b) => (b.shares * b.currentPrice) - (a.shares * a.currentPrice))
                    .slice(0, 3);
                
                let newsContext = '';
                for (const holding of topHoldings) {
                    const news = await fetchMarketNews(holding.ticker);
                    if (news.length > 0) {
                        newsContext += `\n${holding.ticker}:\n`;
                        news.slice(0, 2).forEach(n => {
                            const sentiment = n.sentiment > 0.15 ? 'üìà Positivo' : 
                                            n.sentiment < -0.15 ? 'üìâ Negativo' : '‚û°Ô∏è Neutral';
                            newsContext += `  - ${n.title} (${sentiment}: ${n.sentiment.toFixed(2)})\n`;
                        });
                    }
                }
                
                // Construir prompt para an√°lisis global
                const contextPrompt = `Analiza el siguiente portafolio de inversi√≥n para los pr√≥ximos 7 d√≠as.\n\n` +
                    `COMPOSICI√ìN DEL PORTAFOLIO:\n` +
                    `- S√≠mbolos: ${tickers}\n` +
                    `- Valor total: $${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2})}\n` +
                    `- N√∫mero de posiciones: ${portfolio.length}\n\n` +
                    `M√âTRICAS GLOBALES:\n` +
                    `- Beta promedio ponderado: ${avgBeta.toFixed(2)}\n` +
                    `- Yield promedio: ${avgYield.toFixed(2)}%\n\n` +
                    `DIVERSIFICACI√ìN SECTORIAL:\n${sectorBreakdown}\n` +
                    (newsContext ? `\nNOTICIAS RECIENTES (Principales Posiciones):\n${newsContext}` : '') +
                    `\nOBJETIVO:\n` +
                    `Eval√∫a si este portafolio diversificado puede alcanzar la meta de 0.35% de retorno semanal (20% anual).\n` +
                    `Considera:\n` +
                    `1. Diversificaci√≥n y balance sectorial\n` +
                    `2. Exposici√≥n al riesgo (Beta global)\n` +
                    `3. Correlaci√≥n entre activos\n` +
                    `4. Sentimiento del mercado seg√∫n noticias\n` +
                    `5. Ajustes recomendados (si aplica)\n\n` +
                    `Responde en espa√±ol con una evaluaci√≥n completa y recomendaciones concretas.`;
                
                const API_URL = "https://api.blackbox.ai/chat/completions";
                const requestData = {
                    "model": "blackboxai/openai/gpt-4",
                    "messages": [{ "role": "user", "content": contextPrompt }],
                    "temperature": 0.7,
                    "max_tokens": 1000,
                    "stream": false
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${BLACKBOX_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const responseData = await response.json();
                
                if (responseData.choices && responseData.choices[0] && responseData.choices[0].message) {
                    const aiResponse = responseData.choices[0].message.content;
                    
                    // Formatear respuesta para an√°lisis global
                    let formattedResponse = `<div class="space-y-4 text-sm leading-relaxed">`;
                    
                    // Resumen del portafolio
                    formattedResponse += `
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h4 class="text-xs font-black uppercase text-slate-400 mb-3">üìä Resumen del Portafolio</h4>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div>
                                    <span class="text-slate-500">Valor Total:</span>
                                    <span class="font-bold text-emerald-400"> $${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Posiciones:</span>
                                    <span class="font-bold text-indigo-400"> ${portfolio.length}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Beta Promedio:</span>
                                    <span class="font-bold text-amber-400"> ${avgBeta.toFixed(2)}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Yield Promedio:</span>
                                    <span class="font-bold text-purple-400"> ${avgYield.toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Diversificaci√≥n sectorial
                    formattedResponse += `
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h4 class="text-xs font-black uppercase text-slate-400 mb-3">üéØ Diversificaci√≥n</h4>
                            <div class="space-y-2 text-xs">
                    `;
                    
                    Object.entries(sectorAllocation).forEach(([sector, value]) => {
                        const percentage = (value/totalValue)*100;
                        formattedResponse += `
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">${sector}</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-indigo-500" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="font-bold text-indigo-400 w-12 text-right">${percentage.toFixed(1)}%</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    formattedResponse += `
                            </div>
                        </div>
                    `;
                    
                    // An√°lisis de IA
                    formattedResponse += `
                        <div class="bg-gradient-to-br from-indigo-900/30 to-purple-900/30 rounded-xl p-4 border border-indigo-500/30">
                            <h4 class="text-xs font-black uppercase text-indigo-300 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-brain"></i> An√°lisis Global del Portafolio
                            </h4>
                            <div class="text-sm leading-relaxed">
                                ${aiResponse.replace(/\n/g, '<br><br>')}
                            </div>
                        </div>
                    `;
                    
                    formattedResponse += `</div>`;
                    
                    openAIModal('PORTAFOLIO GLOBAL', formattedResponse);
                } else {
                    throw new Error('Respuesta inv√°lida de la API');
                }
            } catch (err) {
                console.error('Error en getGlobalForecast:', err);
                openAIModal('PORTAFOLIO GLOBAL', `<p class="text-rose-400 text-sm font-bold">‚ùå Error al generar an√°lisis global</p><p class="text-slate-400 text-xs mt-2">Revisa la conexi√≥n o el saldo de la API.</p><pre class="text-xs text-slate-500 mt-3 bg-slate-900/50 p-3 rounded-lg overflow-auto">${err.message}</pre>`);
            }
        }

        // --- VISUALIZACI√ìN ---
        function updateCharts(stats) {
            updateWeeklyChart(stats);
            updateDiversificationChart();
        }

        function updateWeeklyChart(stats) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            const total = stats.val;
            const weeklyRate = 0.0035; // 0.35% semanal

            const labels = Array.from({length: 8}, (_, i) => `D√≠a ${i}`);
            // Proyecci√≥n lineal/compuesta diaria para 1 semana
            const dailyRate = Math.pow(1 + weeklyRate, 1/7) - 1;
            const dataPoints = Array.from({length: 8}, (_, i) => total * Math.pow(1 + dailyRate, i));

            if (chartInstances.weekly) chartInstances.weekly.destroy();
            if (portfolio.length === 0) return;

            chartInstances.weekly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Proyecci√≥n 7 D√≠as',
                        data: dataPoints,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { callback: v => '$' + v.toLocaleString() }, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateDiversificationChart() {
            const ctx = document.getElementById('diversificationChart').getContext('2d');
            const data = portfolio.map(item => item.shares * item.currentPrice);
            const labels = portfolio.map(item => item.ticker);

            if (chartInstances.diversification) chartInstances.diversification.destroy();
            if (portfolio.length === 0) return;

            chartInstances.diversification = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#3b82f6', '#ec4899', '#0f172a'],
                        borderWidth: 0,
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold', size: 9 } } }
                    }
                }
            });
        }

        // --- UTILIDADES ---
        function saveAndRefresh() {
            // Save to multi-portfolio system
            portfolios[currentPortfolioId].positions = portfolio;
            localStorage.setItem('sv_portfolios_unified', JSON.stringify(portfolios));
            // Also save to legacy format for compatibility
            localStorage.setItem('sv_dividend_portfolio', JSON.stringify(portfolio));
            renderDashboard();
            updateAllVisualizations();
        }

        function toggleModal() {
            document.getElementById('sim-modal').classList.toggle('hidden');
        }

        function removePosition(itemId) {
            if (confirm('¬øEst√°s seguro de eliminar esta posici√≥n del portafolio?')) {
                portfolio = portfolio.filter(item => item.id !== itemId);
                saveAndRefresh();
            }
        }

        document.getElementById('sim-form').onsubmit = (e) => {
            e.preventDefault();
            const ticker = document.getElementById('sim-ticker').value.toUpperCase();
            const shares = parseFloat(document.getElementById('sim-shares').value);
            const cost = parseFloat(document.getElementById('sim-cost').value);
            const ref = stockRef[ticker] || { beta: 1.0, dgr: 5.0, yield: 3.5, sector: 'Simulaci√≥n' };

            // Usar precio en cach√© si est√° disponible, sino usar el costo ingresado
            const currentPrice = (cachedPrices.prices && cachedPrices.prices[ticker]) 
                ? cachedPrices.prices[ticker] 
                : cost;

            portfolio.push({
                id: Date.now(), ticker, shares, avgCost: cost,
                currentPrice: currentPrice, beta: ref.beta, dgr: ref.dgr,
                dividendYield: ref.yield, sector: ref.sector
            });
            saveAndRefresh();
            toggleModal();
            e.target.reset();
            document.getElementById('ticker-price-info').classList.add('hidden');
        };

        function startTimer() {
            setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                document.getElementById('update-timer').innerText = `Next Refresh: ${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) {
                    updatePrices();
                    timeLeft = 300;
                }
            }, 1000);
        }

        // --- CHART POPUP HOVER ---
        async function showChartPopup(event, ticker) {
            clearTimeout(popupTimeout);
            
            popupTimeout = setTimeout(async () => {
                const popup = document.getElementById('chart-popup');
                const loader = document.getElementById('popup-loader');
                const tickerEl = document.getElementById('popup-ticker');
                const nameEl = document.getElementById('popup-name');
                const statsEl = document.getElementById('popup-stats');
                
                // Posicionar popup
                const rect = event.target.closest('td').getBoundingClientRect();
                popup.style.left = `${rect.right + 20}px`;
                popup.style.top = `${rect.top}px`;
                
                // Mostrar popup con info b√°sica
                tickerEl.textContent = ticker;
                nameEl.textContent = stockRef[ticker]?.name || 'Cargando...';
                statsEl.innerHTML = '<div class="col-span-3 text-xs text-slate-400">Cargando datos...</div>';
                loader.classList.remove('hidden');
                popup.classList.add('active');
                
                // Obtener datos hist√≥ricos
                const historicalData = await fetchHistoricalData(ticker);
                
                if (historicalData && historicalData.dates.length > 0) {
                    loader.classList.add('hidden');
                    renderPopupChart(historicalData);
                    displayPopupStats(historicalData, ticker);
                } else {
                    loader.classList.add('hidden');
                    statsEl.innerHTML = '<div class="col-span-3 text-xs text-rose-400">‚ö†Ô∏è No hay datos disponibles</div>';
                }
            }, 500); // Delay de 500ms antes de mostrar
        }

        function hideChartPopup() {
            clearTimeout(popupTimeout);
            const popup = document.getElementById('chart-popup');
            popup.classList.remove('active');
        }

        async function fetchHistoricalData(ticker) {
            // Verificar cach√© (v√°lido por 1 hora)
            const now = Date.now();
            const cacheKey = ticker;
            
            if (historicalDataCache[cacheKey] && 
                (now - historicalDataCache[cacheKey].timestamp) < 3600000) {
                console.log(`Usando datos hist√≥ricos en cach√© para ${ticker}`);
                return historicalDataCache[cacheKey].data;
            }

            try {
                console.log(`üìä Obteniendo datos hist√≥ricos de ${ticker} con Marketstack...`);
                
                // Intentar primero con Marketstack (m√°s confiable para hist√≥ricos)
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                
                const dateFrom = sevenDaysAgo.toISOString().split('T')[0];
                const dateTo = today.toISOString().split('T')[0];
                
                const res = await fetch(
                    `https://api.marketstack.com/v1/eod?access_key=${MARKETSTACK_API_KEY}&symbols=${ticker}&date_from=${dateFrom}&date_to=${dateTo}&limit=7`
                );
                const data = await res.json();

                if (data.data && data.data.length > 0) {
                    // Marketstack devuelve datos m√°s recientes primero, invertir para orden cronol√≥gico
                    const sortedData = data.data.reverse();
                    
                    const dates = sortedData.map(d => d.date.split('T')[0]);
                    const prices = sortedData.map(d => parseFloat(d.close));
                    
                    const historicalData = {
                        dates: dates.map(d => new Date(d).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })),
                        prices: prices,
                        high: Math.max(...prices),
                        low: Math.min(...prices),
                        change: ((prices[prices.length - 1] - prices[0]) / prices[0] * 100).toFixed(2)
                    };

                    // Guardar en cach√©
                    historicalDataCache[cacheKey] = {
                        timestamp: now,
                        data: historicalData
                    };
                    localStorage.setItem('sv_historical_data', JSON.stringify(historicalDataCache));

                    console.log(`‚úì Datos hist√≥ricos obtenidos: ${prices.length} d√≠as`);
                    return historicalData;
                } else {
                    console.warn(`‚ö†Ô∏è Marketstack no devolvi√≥ datos para ${ticker}, intentando Alpha Vantage...`);
                    return await fetchHistoricalDataFallback(ticker);
                }
            } catch (err) {
                console.error(`‚ùå Error obteniendo datos hist√≥ricos de ${ticker}:`, err);
                // Fallback a Alpha Vantage
                return await fetchHistoricalDataFallback(ticker);
            }
        }
        
        // Fallback para datos hist√≥ricos con Alpha Vantage
        async function fetchHistoricalDataFallback(ticker) {
            try {
                const res = await fetch(
                    `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${ticker}&apikey=${ALPHA_VANTAGE_KEY}&outputsize=compact`
                );
                const data = await res.json();

                if (data['Time Series (Daily)']) {
                    const timeSeries = data['Time Series (Daily)'];
                    const dates = Object.keys(timeSeries).slice(0, 7).reverse();
                    const prices = dates.map(date => parseFloat(timeSeries[date]['4. close']));
                    
                    const historicalData = {
                        dates: dates.map(d => new Date(d).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })),
                        prices: prices,
                        high: Math.max(...prices),
                        low: Math.min(...prices),
                        change: ((prices[prices.length - 1] - prices[0]) / prices[0] * 100).toFixed(2)
                    };

                    // Guardar en cach√©
                    historicalDataCache[ticker] = {
                        timestamp: Date.now(),
                        data: historicalData
                    };
                    localStorage.setItem('sv_historical_data', JSON.stringify(historicalDataCache));

                    console.log(`‚úì Fallback exitoso con Alpha Vantage`);
                    return historicalData;
                } else {
                    console.warn(`No hay datos hist√≥ricos disponibles para ${ticker}`);
                    return null;
                }
            } catch (err) {
                console.error(`Error en fallback Alpha Vantage para ${ticker}:`, err);
                return null;
            }
        }

        function renderPopupChart(data) {
            const ctx = document.getElementById('popup-chart').getContext('2d');
            
            if (chartInstances.popup) {
                chartInstances.popup.destroy();
            }

            const isPositive = parseFloat(data.change) >= 0;

            chartInstances.popup = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Precio',
                        data: data.prices,
                        borderColor: isPositive ? '#10b981' : '#ef4444',
                        backgroundColor: isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: isPositive ? '#10b981' : '#ef4444',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: '#6366f1',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: (context) => `$${context.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 10 },
                                callback: v => '$' + v.toFixed(0)
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 9 }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function displayPopupStats(data, ticker) {
            const statsEl = document.getElementById('popup-stats');
            const isPositive = parseFloat(data.change) >= 0;
            const stock = stockRef[ticker];

            statsEl.innerHTML = `
                <div class="bg-slate-800/50 rounded-lg p-2">
                    <p class="text-[9px] text-slate-500 uppercase font-black">Cambio 7D</p>
                    <p class="text-sm font-black ${isPositive ? 'text-emerald-400' : 'text-rose-400'}">
                        ${isPositive ? '+' : ''}${data.change}%
                    </p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-2">
                    <p class="text-[9px] text-slate-500 uppercase font-black">M√°ximo</p>
                    <p class="text-sm font-black text-indigo-400">$${data.high.toFixed(2)}</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-2">
                    <p class="text-[9px] text-slate-500 uppercase font-black">M√≠nimo</p>
                    <p class="text-sm font-black text-amber-400">$${data.low.toFixed(2)}</p>
                </div>
            `;
        }

        // ===== MULTI-PORTFOLIO MANAGEMENT v3.0 =====
        
        function getCurrentPortfolio() {
            return portfolios[currentPortfolioId]?.positions || [];
        }

        function savePortfolios() {
            portfolios[currentPortfolioId].positions = portfolio;
            localStorage.setItem('sv_portfolios_unified', JSON.stringify(portfolios));
        }

        function loadPortfolioSelector() {
            const selector = document.getElementById('portfolio-selector');
            if (!selector) return;
            
            selector.innerHTML = '';
            Object.entries(portfolios).forEach(([id, pf]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = pf.name;
                if (id === currentPortfolioId) option.selected = true;
                selector.appendChild(option);
            });
        }

        function switchPortfolio() {
            currentPortfolioId = document.getElementById('portfolio-selector').value;
            portfolio = getCurrentPortfolio();
            renderDashboard();
            updateAllVisualizations();
        }

        function openPortfolioManager() {
            document.getElementById('portfolio-manager-modal').classList.remove('hidden');
            renderPortfolioList();
        }

        function closePortfolioManager() {
            document.getElementById('portfolio-manager-modal').classList.add('hidden');
        }

        function createNewPortfolio() {
            const name = document.getElementById('new-portfolio-name').value.trim();
            if (!name) {
                alert('Por favor ingresa un nombre');
                return;
            }
            
            const id = Date.now().toString();
            portfolios[id] = { name, positions: [] };
            savePortfolios();
            loadPortfolioSelector();
            renderPortfolioList();
            document.getElementById('new-portfolio-name').value = '';
            alert(`‚úÖ Portafolio "${name}" creado exitosamente`);
        }

        function deletePortfolio(id) {
            if (id === 'default') {
                alert('‚ùå No puedes eliminar el portafolio principal');
                return;
            }
            
            const pfName = portfolios[id].name;
            if (confirm(`¬øEliminar portafolio "${pfName}"?\\n\\nEsta acci√≥n no se puede deshacer.`)) {
                delete portfolios[id];
                if (currentPortfolioId === id) {
                    currentPortfolioId = 'default';
                    switchPortfolio();
                }
                savePortfolios();
                loadPortfolioSelector();
                renderPortfolioList();
                alert(`üóëÔ∏è Portafolio "${pfName}" eliminado`);
            }
        }

        function renderPortfolioList() {
            const container = document.getElementById('portfolio-list-container');
            if (!container) return;
            
            container.innerHTML = Object.entries(portfolios).map(([id, pf]) => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition-all border-2 ${id === currentPortfolioId ? 'border-indigo-500' : 'border-transparent'}">
                    <div>
                        <p class="font-bold text-slate-800 text-sm">${pf.name}</p>
                        <p class="text-xs text-slate-500">${pf.positions.length} posiciones ${id === currentPortfolioId ? '‚≠ê En uso' : ''}</p>
                    </div>
                    <div class="flex gap-2">
                        ${id !== currentPortfolioId ? `
                        <button onclick="currentPortfolioId='${id}'; switchPortfolio(); closePortfolioManager()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-700 transition-all">
                            Seleccionar
                        </button>
                        ` : '<span class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl text-xs font-bold">‚úì Activo</span>'}
                        ${id !== 'default' ? `
                        <button onclick="deletePortfolio('${id}')" class="bg-rose-600 text-white px-3 py-2 rounded-xl text-xs font-bold hover:bg-rose-700 transition-all">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ===== TAB SYSTEM =====
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
            });
            
            const content = document.getElementById(`content-${tabName}`);
            const tab = document.getElementById(`tab-${tabName}`);
            
            if (content) content.classList.remove('hidden');
            if (tab) tab.classList.add('tab-active');
            
            // Update charts for specific tabs
            if (tabName === 'projections') setTimeout(updateAllProjections, 100);
            if (tabName === 'risk') setTimeout(updateRiskCharts, 100);
            if (tabName === 'comparison') setTimeout(updateComparisonView, 100);
            if (tabName === 'news') setTimeout(loadPortfolioNews, 100);
        }

        // ===== SETTINGS MANAGEMENT =====
        
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            if (!modal) return;
            
            modal.classList.remove('hidden');
            document.getElementById('settings-risk-free-rate').value = globalSettings.riskFreeRate;
            document.getElementById('settings-refresh-interval').value = globalSettings.refreshInterval;
            document.getElementById('settings-market-vol').value = globalSettings.marketVolatility;
            
            document.getElementById('settings-portfolio-count').textContent = Object.keys(portfolios).length;
            const cacheCount = cachedPrices.prices ? Object.keys(cachedPrices.prices).length : 0;
            document.getElementById('settings-cache-count').textContent = `${cacheCount} s√≠mbolos`;
        }

        function closeSettings() {
            document.getElementById('settings-modal')?.classList.add('hidden');
        }

        function saveGlobalSettings() {
            globalSettings.riskFreeRate = parseFloat(document.getElementById('settings-risk-free-rate').value);
            globalSettings.refreshInterval = parseInt(document.getElementById('settings-refresh-interval').value);
            globalSettings.marketVolatility = parseFloat(document.getElementById('settings-market-vol').value);
            
            localStorage.setItem('sv_global_settings', JSON.stringify(globalSettings));
            alert('‚úÖ Configuraci√≥n guardada correctamente');
            
            updateRiskCharts();
            closeSettings();
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ¬øELIMINAR TODOS LOS DATOS?\\n\\nEsto borrar√°:\\n- Todos los portafolios\\n- Configuraci√≥n\\n- Cache\\n\\n¬øContinuar?')) {
                return;
            }
            
            localStorage.removeItem('sv_portfolios_unified');
            localStorage.removeItem('sv_global_settings');
            localStorage.removeItem('sv_cached_prices');
            localStorage.removeItem('sv_historical_data');
            
            alert('‚úÖ Datos eliminados. Recargando...');
            location.reload();
        }

        // ===== PROJECTION CHARTS =====
        
        function updateAllProjections() {
            updateMultiScenarioChart();
            updateMonthlyBreakdownChart();
        }

        function updateMultiScenarioChart() {
            const ctx = document.getElementById('multi-scenario-chart');
            if (!ctx) return;
            
            const total = portfolio.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
            if (total === 0) return;
            
            const annualTarget = parseFloat(document.getElementById('annual-target-input')?.value || 20) / 100;
            const weeks = parseInt(document.getElementById('projection-weeks')?.value || 52);
            
            const baseRate = Math.pow(1 + annualTarget, 1/52) - 1;
            const optRate = Math.pow(1 + annualTarget * 1.1, 1/52) - 1;
            const pesRate = Math.pow(1 + annualTarget * 0.9, 1/52) - 1;
            
            const labels = Array.from({length: weeks + 1}, (_, i) => i === 0 ? 'Hoy' : `S${i}`);
            
            if (chartInstances.multiScenario) chartInstances.multiScenario.destroy();
            
            chartInstances.multiScenario = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: `Optimista (+${(annualTarget * 110).toFixed(0)}%)`,
                            data: Array.from({length: weeks + 1}, (_, i) => total * Math.pow(1 + optRate, i)),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.05)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4
                        },
                        {
                            label: `Base (${(annualTarget * 100).toFixed(0)}%)`,
                            data: Array.from({length: weeks + 1}, (_, i) => total * Math.pow(1 + baseRate, i)),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: `Pesimista (${(annualTarget * 90).toFixed(0)}%)`,
                            data: Array.from({length: weeks + 1}, (_, i) => total * Math.pow(1 + pesRate, i)),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.05)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 11, weight: 'bold' } } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: v => '$' + v.toLocaleString() },
                            grid: { color: '#f1f5f9' }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 13,
                                callback: (val, index) => index % Math.ceil(weeks/12) === 0 ? labels[index] : ''
                            }
                        }
                    }
                }
            });
        }

        function updateMonthlyBreakdownChart() {
            const ctx = document.getElementById('monthly-breakdown-chart');
            if (!ctx) return;
            
            const total = portfolio.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
            if (total === 0) return;
            
            const annualTarget = parseFloat(document.getElementById('annual-target-input')?.value || 20) / 100;
            const monthlyRate = Math.pow(1 + annualTarget, 1/12) - 1;
            
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const cumulativeValues = Array.from({length: 12}, (_, i) => total * Math.pow(1 + monthlyRate, i + 1));
            const monthlyGains = cumulativeValues.map((v, i) => {
                const prev = i === 0 ? total : cumulativeValues[i - 1];
                return v - prev;
            });
            
            if (chartInstances.monthly) chartInstances.monthly.destroy();
            
            chartInstances.monthly = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Ganancia Mensual',
                        data: monthlyGains,
                        backgroundColor: '#6366f1',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `+$${ctx.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => '$' + v.toLocaleString() }
                        }
                    }
                }
            });
        }

        // ===== RISK ANALYSIS =====
        
        function updateRiskCharts() {
            updateRiskMetrics();
            updateBetaDistributionChart();
            updateConcentrationRiskChart();
        }

        function updateRiskMetrics() {
            let total = 0;
            let weightedBeta = 0;
            
            portfolio.forEach(p => {
                const value = p.shares * p.currentPrice;
                total += value;
                weightedBeta += p.beta * value;
            });
            
            const avgBeta = total > 0 ? weightedBeta / total : 0;
            const volatility = avgBeta * globalSettings.marketVolatility;
            const annualReturn = globalSettings.annualTarget;
            
            const sharpe = ((annualReturn - globalSettings.riskFreeRate) / volatility).toFixed(2);
            const sortino = (sharpe * 1.4).toFixed(2);
            const var95 = (total * 0.05 * avgBeta);
            const maxDrawdown = (avgBeta * 8).toFixed(2);
            
            const riskVol = document.getElementById('risk-volatility');
            const riskSharpe = document.getElementById('risk-sharpe');
            const riskSortino = document.getElementById('risk-sortino');
            const riskVar = document.getElementById('risk-var');
            
            if (riskVol) riskVol.textContent = `${volatility.toFixed(2)}%`;
            if (riskSharpe) riskSharpe.textContent = sharpe;
            if (riskSortino) riskSortino.textContent = sortino;
            if (riskVar) riskVar.textContent = `$${var95.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            
            // Update main KPIs
            const sharpeRatio = document.getElementById('sharpe-ratio');
            const sharpeStatus = document.getElementById('sharpe-status');
            const maxDD = document.getElementById('max-drawdown');
            
            if (sharpeRatio) sharpeRatio.textContent = sharpe;
            if (sharpeStatus) sharpeStatus.textContent = sharpe > 1.5 ? 'Excelente' : sharpe > 1 ? 'Muy Bueno' : sharpe > 0.5 ? 'Bueno' : 'Regular';
            if (maxDD) maxDD.textContent = `${maxDrawdown}%`;
        }

        function updateBetaDistributionChart() {
            const ctx = document.getElementById('beta-distribution-chart');
            if (!ctx) return;
            
            const ranges = {
                'Muy Bajo (<0.5)': 0,
                'Bajo (0.5-0.8)': 0,
                'Medio (0.8-1.2)': 0,
                'Alto (1.2-1.5)': 0,
                'Muy Alto (>1.5)': 0
            };
            
            portfolio.forEach(p => {
                const value = p.shares * p.currentPrice;
                if (p.beta < 0.5) ranges['Muy Bajo (<0.5)'] += value;
                else if (p.beta < 0.8) ranges['Bajo (0.5-0.8)'] += value;
                else if (p.beta < 1.2) ranges['Medio (0.8-1.2)'] += value;
                else if (p.beta < 1.5) ranges['Alto (1.2-1.5)'] += value;
                else ranges['Muy Alto (>1.5)'] += value;
            });
            
            if (chartInstances.betaDist) chartInstances.betaDist.destroy();
            
            chartInstances.betaDist = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Distribuci√≥n',
                        data: Object.values(ranges),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#991b1b'],
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.x.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { callback: v => '$' + v.toLocaleString() } }
                    }
                }
            });
        }

        function updateConcentrationRiskChart() {
            const ctx = document.getElementById('concentration-risk-chart');
            if (!ctx) return;
            
            let total = 0;
            const values = portfolio.map(p => {
                const value = p.shares * p.currentPrice;
                total += value;
                return { ticker: p.ticker, value };
            }).sort((a, b) => b.value - a.value);
            
            if (values.length === 0) return;
            
            const topN = values.slice(0, 5);
            const othersValue = values.slice(5).reduce((sum, v) => sum + v.value, 0);
            
            const labels = topN.map(v => `${v.ticker} (${(v.value/total*100).toFixed(1)}%)`);
            const data = topN.map(v => v.value);
            
            if (othersValue > 0) {
                labels.push(`Otros (${(othersValue/total*100).toFixed(1)}%)`);
                data.push(othersValue);
            }
            
            if (chartInstances.concentration) chartInstances.concentration.destroy();
            
            chartInstances.concentration = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Concentraci√≥n',
                        data: data,
                        backgroundColor: data.map(v => {
                            const pct = v / total * 100;
                            if (pct > 30) return '#ef4444';
                            if (pct > 20) return '#f59e0b';
                            return '#10b981';
                        }),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.y.toLocaleString()} (${(ctx.parsed.y/total*100).toFixed(1)}%)`
                            }
                        }
                    },
                    scales: {
                        y: { ticks: { callback: v => '$' + v.toLocaleString() } }
                    }
                }
            });
        }

        // ===== COMPARISON =====
        
        function updateComparisonView() {
            const container = document.getElementById('comparison-table-container');
            if (!container) return;
            
            const allPortfolios = Object.entries(portfolios);
            
            if (allPortfolios.length === 1) {
                container.innerHTML = '<p class="text-slate-400 text-sm text-center py-8">Crea m√°s portafolios para poder compararlos</p>';
                return;
            }
            
            const html = `
                <div class="overflow-x-auto custom-scroll">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3 text-left font-bold uppercase text-xs">Portafolio</th>
                                <th class="p-3 text-right font-bold uppercase text-xs">Valor</th>
                                <th class="p-3 text-right font-bold uppercase text-xs">Posic.</th>
                                <th class="p-3 text-right font-bold uppercase text-xs">Beta</th>
                                <th class="p-3 text-right font-bold uppercase text-xs">Sharpe</th>
                                <th class="p-3 text-right font-bold uppercase text-xs">Retorno</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allPortfolios.map(([id, pf]) => {
                                const total = pf.positions.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
                                const totalCost = pf.positions.reduce((sum, p) => sum + (p.shares * p.avgCost), 0);
                                const avgBeta = total > 0 ? pf.positions.reduce((sum, p) => sum + (p.beta * p.shares * p.currentPrice), 0) / total : 0;
                                const totalReturn = totalCost > 0 ? ((total - totalCost) / totalCost * 100) : 0;
                                const vol = avgBeta * globalSettings.marketVolatility;
                                const sharpe = vol > 0 ? ((globalSettings.annualTarget - globalSettings.riskFreeRate) / vol).toFixed(2) : '0.00';
                                
                                return `
                                    <tr class="border-b hover:bg-slate-50 transition-all ${id === currentPortfolioId ? 'bg-indigo-50 font-bold' : ''}">
                                        <td class="p-3 font-bold">${pf.name} ${id === currentPortfolioId ? '‚≠ê' : ''}</td>
                                        <td class="p-3 text-right font-bold">$${total.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td class="p-3 text-right">${pf.positions.length}</td>
                                        <td class="p-3 text-right">${avgBeta.toFixed(2)}</td>
                                        <td class="p-3 text-right">${sharpe}</td>
                                        <td class="p-3 text-right font-bold ${totalReturn >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
                                            ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            updateComparisonChart();
        }

        function updateComparisonChart() {
            const ctx = document.getElementById('portfolio-comparison-chart');
            if (!ctx) return;
            
            const allPortfolios = Object.entries(portfolios);
            const names = allPortfolios.map(([id, pf]) => pf.name);
            const values = allPortfolios.map(([id, pf]) => 
                pf.positions.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0)
            );
            const betas = allPortfolios.map(([id, pf]) => {
                const total = pf.positions.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
                return total > 0 ? pf.positions.reduce((sum, p) => sum + (p.beta * p.shares * p.currentPrice), 0) / total : 0;
            });
            
            if (chartInstances.comparison) chartInstances.comparison.destroy();
            
            chartInstances.comparison = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [
                        {
                            label: 'Valor ($)',
                            data: values,
                            backgroundColor: '#6366f1',
                            borderRadius: 8,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Beta (Riesgo)',
                            data: betas,
                            type: 'line',
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { callback: v => '$' + v.toLocaleString() },
                            title: { display: true, text: 'Valor ($)', font: { weight: 'bold' } }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Beta (Riesgo)', font: { weight: 'bold' } }
                        }
                    }
                }
            });
        }

        // ===== HELPER FUNCTIONS =====
        
        function updateAllVisualizations() {
            const stats = calculateCurrentStats();
            updateHeaderStats(stats);
            updateCharts(stats);
            
            // Update tab-specific content if visible
            if (!document.getElementById('content-projections')?.classList.contains('hidden')) {
                updateAllProjections();
            }
            if (!document.getElementById('content-risk')?.classList.contains('hidden')) {
                updateRiskCharts();
            }
            if (!document.getElementById('content-comparison')?.classList.contains('hidden')) {
                updateComparisonView();
            }
        }

        function calculateCurrentStats() {
            let stats = { val: 0, cost: 0, beta: 0, yield: 0, dgr: 0 };
            
            portfolio.forEach(item => {
                const marketVal = item.shares * item.currentPrice;
                const costBasis = item.shares * item.avgCost;
                
                stats.val += marketVal;
                stats.cost += costBasis;
                stats.beta += (item.beta * marketVal);
                stats.yield += (item.dividendYield * marketVal);
                stats.dgr += (item.dgr * marketVal);
            });
            
            return stats;
        }

        // ===== NEWS FUNCTIONS =====
        
        async function loadPortfolioNews() {
            const container = document.getElementById('portfolio-news-feed');
            if (!container) return;
            
            // Show loading
            container.innerHTML = `
                <div class="flex items-center justify-center p-12">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                        <p class="text-sm text-slate-500 font-bold">Cargando noticias...</p>
                    </div>
                </div>
            `;
            
            try {
                // Import news module
                const newsModule = await import('/assets/js/news.js');
                
                // Get portfolio symbols
                const symbols = [...new Set(portfolio.map(p => p.ticker))];
                
                if (symbols.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-12 text-slate-500">
                            <i class="fa-solid fa-newspaper text-5xl mb-4 opacity-50"></i>
                            <p class="font-bold text-lg mb-2">No hay posiciones en el portafolio</p>
                            <p class="text-sm">Agrega activos para ver noticias relacionadas</p>
                        </div>
                    `;
                    return;
                }
                
                // Fetch news for each symbol (limited to first 5 to avoid rate limits)
                const limitedSymbols = symbols.slice(0, 5);
                const newsResults = await newsModule.getBatchNews(limitedSymbols, 3);
                
                // Combine all news
                const allNews = [];
                Object.entries(newsResults).forEach(([symbol, articles]) => {
                    articles.forEach(article => {
                        allNews.push({ ...article, symbol });
                    });
                });
                
                if (allNews.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-12 text-slate-500">
                            <i class="fa-solid fa-newspaper text-5xl mb-4 opacity-50"></i>
                            <p class="font-bold text-lg mb-2">No hay noticias disponibles</p>
                            <p class="text-sm">Las noticias se actualizan peri√≥dicamente en segundo plano</p>
                        </div>
                    `;
                    return;
                }
                
                // Apply filters
                const typeFilter = document.getElementById('news-type-filter')?.value;
                const sentimentFilter = document.getElementById('news-sentiment-filter')?.value;
                
                let filteredNews = allNews;
                if (typeFilter) {
                    filteredNews = filteredNews.filter(n => n.type === typeFilter);
                }
                if (sentimentFilter) {
                    filteredNews = filteredNews.filter(n => n.sentiment === sentimentFilter);
                }
                
                // Sort by date
                filteredNews.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                
                // Group by symbol
                const newsBySymbol = {};
                filteredNews.forEach(article => {
                    if (!newsBySymbol[article.symbol]) {
                        newsBySymbol[article.symbol] = [];
                    }
                    newsBySymbol[article.symbol].push(article);
                });
                
                // Render sections
                let html = '';
                Object.entries(newsBySymbol).forEach(([symbol, articles]) => {
                    html += `
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <span class="bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg font-mono">${symbol}</span>
                                <span class="text-sm text-slate-500 font-normal">${articles.length} ${articles.length === 1 ? 'art√≠culo' : 'art√≠culos'}</span>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${articles.map(article => renderNewsCard(article)).join('')}
                            </div>
                        </div>
                    `;
                });
                
                if (symbols.length > 5) {
                    html += `
                        <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                            <p class="text-sm text-amber-800">
                                <i class="fa-solid fa-info-circle mr-2"></i>
                                Mostrando noticias de los primeros 5 s√≠mbolos de tu portafolio.
                                Total de s√≠mbolos: ${symbols.length}
                            </p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading news:', error);
                container.innerHTML = `
                    <div class="text-center p-12 text-rose-500">
                        <i class="fa-solid fa-exclamation-triangle text-5xl mb-4 opacity-50"></i>
                        <p class="font-bold text-lg mb-2">Error al cargar noticias</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderNewsCard(article) {
            const publishedDate = new Date(article.publishedAt);
            const timeAgo = getTimeAgo(publishedDate);
            
            const sentimentBadge = article.sentiment ? 
                `<span class="px-2 py-1 rounded-full text-xs font-bold ${getSentimentClass(article.sentiment)}">
                    ${article.sentiment === 'positive' ? 'üìà' : article.sentiment === 'negative' ? 'üìâ' : '‚ûñ'} 
                    ${article.sentiment}
                </span>` : '';
            
            const thumbnail = article.thumbnail ? 
                `<img src="${article.thumbnail}" alt="${article.title}" class="w-full h-32 object-cover rounded-t-xl" onerror="this.style.display='none'">` : '';
            
            return `
                <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-all border border-slate-200 overflow-hidden">
                    ${thumbnail}
                    <div class="p-4">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <h3 class="font-bold text-sm text-slate-800 line-clamp-2 flex-1">
                                ${escapeHtml(article.title)}
                            </h3>
                            ${sentimentBadge}
                        </div>
                        
                        ${article.summary ? `
                            <p class="text-xs text-slate-600 mb-3 line-clamp-2">${escapeHtml(article.summary)}</p>
                        ` : ''}
                        
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex items-center gap-2 text-slate-500">
                                <span class="font-semibold">${escapeHtml(article.publisher)}</span>
                                <span>‚Ä¢</span>
                                <span>${timeAgo}</span>
                            </div>
                            <a href="${article.url}" target="_blank" rel="noopener noreferrer" 
                               class="text-indigo-600 hover:text-indigo-700 font-bold">
                                Leer ‚Üí
                            </a>
                        </div>
                        
                        <div class="mt-2 pt-2 border-t border-slate-100">
                            <span class="text-[10px] text-slate-400 uppercase font-bold">
                                ${getSourceIcon(article.source)} ${article.source}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            const intervals = {
                a√±o: 31536000,
                mes: 2592000,
                semana: 604800,
                d√≠a: 86400,
                hora: 3600,
                minuto: 60
            };
            
            for (const [name, secondsInInterval] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInInterval);
                if (interval >= 1) {
                    return `hace ${interval} ${name}${interval > 1 ? 's' : ''}`;
                }
            }
            
            return 'hace un momento';
        }
        
        function getSentimentClass(sentiment) {
            const classes = {
                positive: 'bg-emerald-100 text-emerald-700',
                negative: 'bg-rose-100 text-rose-700',
                neutral: 'bg-slate-100 text-slate-600'
            };
            return classes[sentiment] || classes.neutral;
        }
        
        function getSourceIcon(source) {
            const icons = {
                yahoo: 'üìä',
                finnhub: 'üìà',
                sec: 'üèõÔ∏è',
                cryptopanic: '‚Çø',
                default: 'üì∞'
            };
            return icons[source] || icons.default;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function refreshPortfolioNews() {
            await loadPortfolioNews();
        }
        
        async function applyNewsFilters() {
            await loadPortfolioNews();
        }
        
        // ===== WEBSOCKET INTEGRATION =====
        
        // Initialize WebSocket listeners
        if (window.wsClient) {
            // Update connection status
            wsClient.on('connected', () => {
                const statusEl = document.getElementById('ws-status');
                if (statusEl) {
                    statusEl.textContent = 'üü¢ En l√≠nea';
                    statusEl.className = 'ml-2 text-[9px] px-2 py-1 rounded-full bg-emerald-100 text-emerald-700';
                }
            });
            
            wsClient.on('disconnected', () => {
                const statusEl = document.getElementById('ws-status');
                if (statusEl) {
                    statusEl.textContent = 'üî¥ Desconectado';
                    statusEl.className = 'ml-2 text-[9px] px-2 py-1 rounded-full bg-rose-100 text-rose-700';
                }
            });
            
            // Handle news notifications
            wsClient.on('news', (data) => {
                console.log('üì∞ Nueva noticia recibida:', data);
                
                // Show toast notification
                showNotification('üì∞ Nuevas noticias disponibles', data.message || 'Actualiza para verlas');
                
                // Auto-refresh if on news tab
                const newsTab = document.getElementById('content-news');
                if (newsTab && !newsTab.classList.contains('hidden')) {
                    setTimeout(() => loadPortfolioNews(), 2000);
                }
            });
            
            // Handle price updates
            wsClient.on('price_update', (data) => {
                console.log('üí∞ Actualizaci√≥n de precios:', data);
                // Update prices in portfolio
                updatePricesFromWebSocket(data);
            });
            
            // Handle custom notifications
            wsClient.on('notification', (data) => {
                console.log('üîî Notificaci√≥n:', data);
                showNotification(data.title || 'Notificaci√≥n', data.message);
            });
        }
        
        function showNotification(title, message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 bg-white border-l-4 border-indigo-600 rounded-xl shadow-xl p-4 z-[100] animate-slide-in max-w-sm';
            toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-1">
                        <h4 class="font-bold text-sm text-slate-800 mb-1">${escapeHtml(title)}</h4>
                        <p class="text-xs text-slate-600">${escapeHtml(message)}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        function updatePricesFromWebSocket(priceData) {
            // Update portfolio positions with new prices
            if (Array.isArray(priceData)) {
                priceData.forEach(update => {
                    const item = portfolio.find(p => p.ticker === update.symbol);
                    if (item) {
                        item.currentPrice = update.price;
                    }
                });
                
                // Refresh dashboard
                renderDashboard();
                updateAllVisualizations();
            }
        }
    </script>
</body>
</html>
