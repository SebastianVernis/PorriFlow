// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String   // Hashed with bcrypt
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  portfolios Portfolio[]
  settings   UserSettings?
  newsPreferences UserNewsPreference?
  mtAccounts MTAccount[]
  mtPositions MTPosition[]
  mtOrders   MTOrder[]
  
  @@map("users")
}

// User Settings
model UserSettings {
  id                String  @id @default(cuid())
  userId            String  @unique
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Financial Settings
  riskFreeRate      Float   @default(4.5)
  marketVolatility  Float   @default(15.0)
  annualTarget      Float   @default(20.0)
  refreshInterval   Int     @default(5)
  currency          String  @default("USD")
  
  // API Keys (encrypted in production)
  marketstackKey    String?
  alphaVantageKey   String?
  blackboxKey       String?
  marketauxKey      String?
  metaapiToken      String?
  metaapiEnabled    Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("user_settings")
}

// Portfolio Model
model Portfolio {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  isDefault   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  positions   Position[]
  mtPositions MTPosition[]
  
  @@index([userId])
  @@map("portfolios")
}

// Position Model
model Position {
  id          String   @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  
  // Asset Info
  ticker      String
  name        String?
  sector      String?
  isCrypto    Boolean  @default(false)
  
  // Position Data
  shares      Float
  avgCost     Float
  currentPrice Float   @default(0)
  
  // Metrics
  beta        Float    @default(1.0)
  dgr         Float    @default(0.0)
  dividendYield Float  @default(0.0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([portfolioId])
  @@index([ticker])
  @@map("positions")
}

// Price Cache Model (optional - for performance)
model PriceCache {
  id          String   @id @default(cuid())
  ticker      String   @unique
  price       Float
  bid         Float?
  ask         Float?
  timestamp   DateTime @default(now())
  source      String   @default("marketstack") // marketstack, alphavantage, etc
  
  updatedAt   DateTime @updatedAt
  
  @@map("price_cache")
}

// Historical Data Cache
model HistoricalData {
  id          String   @id @default(cuid())
  ticker      String
  date        DateTime
  open        Float
  high        Float
  low         Float
  close       Float
  volume      Float?
  
  createdAt   DateTime @default(now())
  
  @@unique([ticker, date])
  @@index([ticker])
  @@map("historical_data")
}

// News Articles
model News {
  id           String   @id @default(cuid())
  ticker       String
  
  // Article Data
  title        String
  summary      String?
  url          String   @unique
  source       String   // yahoo, finnhub, sec, cryptopanic
  publisher    String?
  thumbnail    String?
  
  // Classification
  type         String   @default("article") // article, filing, earnings, dividend, merger
  category     String?  // earnings, dividends, merger, acquisition, regulation, market
  sentiment    String?  // positive, negative, neutral
  
  // Timestamps
  publishedAt  DateTime
  fetchedAt    DateTime @default(now())
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([ticker])
  @@index([publishedAt])
  @@index([type])
  @@index([category])
  @@map("news")
}

// User News Preferences
model UserNewsPreference {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification Settings
  enablePush     Boolean  @default(true)
  minSentiment   String?  // Only notify on positive/negative
  categories     String[] // Filter by categories
  tickers        String[] // Specific tickers to watch
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([userId])
  @@map("user_news_preferences")
}

// ============================================
// MetaTrader Integration Models
// ============================================

// MetaTrader Account
model MTAccount {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // MetaAPI Configuration
  metaapiAccountId    String   @unique
  accountName         String
  accountType         String   // 'cloud', 'self-hosted'
  platform            String   // 'mt4', 'mt5'
  broker              String
  server              String
  login               String
  
  // Account Status
  status              String   @default("disconnected") // 'connected', 'disconnected', 'error', 'deploying'
  isActive            Boolean  @default(true)
  lastSyncAt          DateTime?
  syncEnabled         Boolean  @default(true)
  
  // MetaAPI Token (encrypted)
  accessToken         String?
  
  // Account Info
  currency            String   @default("USD")
  leverage            Int?
  accountBalance      Float?
  accountEquity       Float?
  accountMargin       Float?
  accountFreeMargin   Float?
  marginLevel         Float?
  
  // Sync Settings
  autoSyncPositions   Boolean  @default(true)
  autoSyncOrders      Boolean  @default(true)
  syncInterval        Int      @default(60) // seconds
  
  // Metadata
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  positions           MTPosition[]
  orders              MTOrder[]
  syncLogs            MTSyncLog[]
  
  @@index([userId])
  @@index([metaapiAccountId])
  @@index([status])
  @@map("mt_accounts")
}

// MetaTrader Position
model MTPosition {
  id                  String   @id @default(cuid())
  mtAccountId         String
  mtAccount           MTAccount @relation(fields: [mtAccountId], references: [id], onDelete: Cascade)
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  portfolioId         String?
  portfolio           Portfolio? @relation(fields: [portfolioId], references: [id], onDelete: SetNull)
  
  // Position Identification
  positionId          String
  ticket              String
  
  // Position Details
  symbol              String
  type                String   // 'POSITION_TYPE_BUY', 'POSITION_TYPE_SELL'
  volume              Float
  openPrice           Float
  currentPrice        Float?
  
  // P&L
  profit              Float?
  swap                Float?
  commission          Float?
  
  // Risk Management
  stopLoss            Float?
  takeProfit          Float?
  
  // Timestamps
  openTime            DateTime
  updateTime          DateTime?
  
  // Sync Status
  isSynced            Boolean  @default(false)
  lastSyncAt          DateTime?
  
  // Metadata
  comment             String?
  magicNumber         Int?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([mtAccountId, positionId])
  @@index([mtAccountId])
  @@index([userId])
  @@index([portfolioId])
  @@index([symbol])
  @@index([openTime])
  @@map("mt_positions")
}

// MetaTrader Order
model MTOrder {
  id                  String   @id @default(cuid())
  mtAccountId         String
  mtAccount           MTAccount @relation(fields: [mtAccountId], references: [id], onDelete: Cascade)
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Order Identification
  orderId             String
  ticket              String
  
  // Order Details
  symbol              String
  type                String
  volume              Float
  openPrice           Float?
  closePrice          Float?
  currentPrice        Float?
  
  // Order Status
  state               String   // 'pending', 'filled', 'cancelled', 'rejected', 'expired'
  
  // P&L
  profit              Float?
  swap                Float?
  commission          Float?
  
  // Risk Management
  stopLoss            Float?
  takeProfit          Float?
  
  // Timestamps
  openTime            DateTime
  closeTime           DateTime?
  expirationTime      DateTime?
  
  // Metadata
  comment             String?
  magicNumber         Int?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([mtAccountId, orderId])
  @@index([mtAccountId])
  @@index([userId])
  @@index([symbol])
  @@index([state])
  @@index([openTime])
  @@map("mt_orders")
}

// MetaTrader Sync Log
model MTSyncLog {
  id                  String   @id @default(cuid())
  mtAccountId         String
  mtAccount           MTAccount @relation(fields: [mtAccountId], references: [id], onDelete: Cascade)
  
  // Sync Details
  syncType            String   // 'positions', 'orders', 'account_info', 'full', 'history'
  status              String   // 'success', 'error', 'partial'
  
  // Results
  itemsSynced         Int      @default(0)
  itemsFailed         Int      @default(0)
  errorMessage        String?
  errorDetails        String?
  
  // Performance
  durationMs          Int?
  
  // Timestamp
  syncedAt            DateTime @default(now())
  
  @@index([mtAccountId])
  @@index([syncType])
  @@index([syncedAt])
  @@index([status])
  @@map("mt_sync_logs")
}
